![](images/topbit.webp)

# Topbit

#### [English Documentation](README.en.md)

topbitæ˜¯åŸºäºNode.jsçš„è¿è¡ŒäºæœåŠ¡ç«¯çš„Webæ¡†æ¶ï¼Œå®ƒæ²¡æœ‰ä»»ä½•ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œåœ¨ç‹¬ç‰¹çš„è·¯ç”±å’Œä¸­é—´ä»¶åˆ†ç»„æ‰§è¡Œæœºåˆ¶ä¸Šè¿›è¡Œäº†æè‡´ä¼˜åŒ–ã€‚


**æ ¸å¿ƒåŠŸèƒ½ï¼š**

* è¯·æ±‚ä¸Šä¸‹æ–‡è®¾è®¡å±è”½æ¥å£å·®å¼‚ã€‚

* å…¨å±€ä¸­é—´ä»¶æ¨¡å¼ã€‚

* è·¯ç”±åˆ†ç»„å’Œè·¯ç”±å‘½åã€‚

* ä¸­é—´ä»¶æŒ‰ç…§è·¯ç”±åˆ†ç»„æ‰§è¡Œã€‚ä¸­é—´ä»¶åŒ¹é…è¯·æ±‚æ–¹æ³•å’Œè·¯ç”±æ¥æ‰§è¡Œã€‚

* å¼€å¯å®ˆæŠ¤è¿›ç¨‹ï¼Œæ”¯æŒå¤šè¿›ç¨‹é›†ç¾¤ä»¥åŠworkerè¿›ç¨‹è‡ªåŠ¨åŒ–è´Ÿè½½è°ƒæ•´ã€‚

* æ˜¾ç¤ºå­è¿›ç¨‹è´Ÿè½½æƒ…å†µã€‚

* é»˜è®¤è§£æbodyæ•°æ®ã€‚

* æ”¯æŒé€šè¿‡é…ç½®å¯ç”¨HTTP/1.1æˆ–æ˜¯HTTP/2æœåŠ¡ã€‚å…è®¸åŒæ—¶æ”¯æŒHTTP/2å’ŒHTTP/1.1ã€‚

* æ”¯æŒé…ç½®å¯ç”¨HTTPSæœåŠ¡ï¼ˆHTTP/2æœåŠ¡å¿…é¡»è¦å¼€å¯HTTPSï¼‰ã€‚

* é™åˆ¶è¯·æ±‚æ•°é‡ã€‚é™åˆ¶ä¸€æ®µæ—¶é—´å†…å•ä¸ªIPçš„æœ€å¤§è®¿é—®æ¬¡æ•°ã€‚

* IPé»‘åå•å’ŒIPç™½åå•ã€‚

* åœ¨clusteræ¨¡å¼ï¼Œç›‘æ§å­è¿›ç¨‹è¶…å‡ºæœ€å¤§å†…å­˜é™åˆ¶åˆ™é‡å¯ã€‚

* å¯é€‰æ‹©æ˜¯å¦å¼€å¯è‡ªåŠ¨è´Ÿè½½æ¨¡å¼ï¼šæ ¹æ®è´Ÿè½½åˆ›å»ºæ–°çš„å­è¿›ç¨‹å¤„ç†è¯·æ±‚ï¼Œå¹¶åœ¨ç©ºé—²æ—¶æ¢å¤åˆå§‹çŠ¶æ€ã€‚

* é»˜è®¤è®¾å®šå’Œç½‘ç»œå®‰å…¨ç›¸å…³çš„é…ç½®ï¼Œé¿å…è½¯ä»¶æœåŠ¡å±‚é¢çš„DDOSæ”»å‡»å’Œå…¶ä»–ç½‘ç»œå®‰å…¨é—®é¢˜ã€‚


## ğŸ“¦å®‰è£…

```javascript
npm i topbit
```

åŒæ ·å¯ä»¥é€šè¿‡yarnå®‰è£…ï¼š

```javascript
yarn add topbit
```


## æœ€å°ç¤ºä¾‹

```javascript
'use strict'

const Topbit = require('topbit')

const app = new Topbit({
  debug: true
})

app.run(1234)

```

å½“ä¸å¡«åŠ è·¯ç”±æ—¶ï¼Œtopbité»˜è®¤æ·»åŠ ä¸€ä¸ªè·¯ç”±ï¼š

`/*`

æµè§ˆå™¨è®¿é—®ä¼šçœ‹åˆ°ä¸€ä¸ªéå¸¸ç®€å•çš„é¡µé¢ï¼Œè¿™ä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿æœ€å¼€å§‹çš„äº†è§£å’Œè®¿é—®æ–‡æ¡£ï¼Œå®ƒä¸ä¼šå¯¹å®é™…å¼€å‘æœ‰ä»»ä½•å½±å“ã€‚


## æ·»åŠ ä¸€ä¸ªè·¯ç”±

``` JavaScript
'use strict'

const Topbit = require('topbit')

const app = new Topbit({
  debug: true
})


app.get('/', async ctx => {
  ctx.to('success')
})

//é»˜è®¤ç›‘å¬0.0.0.0ï¼Œå‚æ•°å’ŒåŸç”Ÿæ¥å£listenä¸€è‡´ã€‚
app.run(1234)

```

ctx.dataæ˜¯è¿”å›çš„å“åº”æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ctx.to(data)
> å…¶å® ctx.to()å†…éƒ¨å°±æ˜¯è®¾ç½®ctx.dataçš„å€¼ã€‚**æ¨èä½¿ç”¨ ctx.to()è®¾ç½®è¿”å›çš„æ•°æ®ã€‚**

## ä½¿ç”¨importå¯¼å…¥

åœ¨ `.mjs` æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ES6çš„importè¿›è¡Œå¯¼å…¥ï¼š

```javascript
import Topbit from 'topbit'

const app = new Topbit({
  debug: true
})

app.get('/', async ctx => {
    ctx.to('success')
})

app.run(1234)

```

## è·¯ç”±å’Œè¯·æ±‚ç±»å‹

HTTPçš„èµ·å§‹è¡Œç»™å‡ºäº†è¯·æ±‚ç±»å‹ï¼Œä¹Ÿè¢«ç§°ä¸ºï¼šè¯·æ±‚æ–¹æ³•ã€‚ç›®å‰çš„è¯·æ±‚æ–¹æ³•ï¼š
```
GET POST PUT PATCH DELETE OPTIONS  TRACE HEAD
```

æœ€å¸¸ç”¨çš„æ˜¯å‰é¢6ä¸ªã€‚å¯¹äºæ¯ä¸ªè¯·æ±‚ç±»å‹ï¼Œrouterä¸­éƒ½æœ‰åŒåä½†æ˜¯å°å†™çš„å‡½æ•°è¿›è¡Œè·¯ç”±æŒ‚è½½ã€‚ä¸ºäº†æ–¹ä¾¿è°ƒç”¨ï¼Œåœ¨åˆå§‹åŒ–appåï¼Œå¯ä»¥ä½¿ç”¨appä¸ŠåŒåçš„å¿«æ·è°ƒç”¨ã€‚ï¼ˆæ¡†æ¶å±‚é¢ä»…æ”¯æŒè¿™äº›ã€‚ï¼‰

**ç¤ºä¾‹ï¼š**

``` JavaScript

'use strict'

const Topbit = require('topbit')

const app = new Topbit({
  debug: true
})

app.get('/', async c => {
  c.to('success')
})

app.get('/p', async c => {
  c.to(`${c.method} ${c.routepath}`)
})

app.post('/', async c => {
  //è¿”å›ä¸Šä¼ çš„æ•°æ®
  c.to(c.body)
})

app.put('/p', async c => {
  c.to({
    method : c.method,
    body : c.body,
    query : c.query
  })
})

//é»˜è®¤ç›‘å¬0.0.0.0ï¼Œå‚æ•°å’ŒåŸç”Ÿæ¥å£listenä¸€è‡´ã€‚
app.run(8080)

```


## è·å–URLå‚æ•°

- URLä¸­çš„æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆ?åé¢a=1&b=2å½¢å¼çš„å‚æ•°ï¼‰è§£æåˆ°c.queryä¸­ã€‚

- è¡¨å•æäº¤çš„æ•°æ®è§£æåˆ°c.bodyä¸­ã€‚

> è¡¨å•å¯¹åº”çš„content-typeä¸ºapplication/x-www-form-urlencoded


``` JavaScript
'use strict';

const Topbit = require('topbit')

let app = new Topbit({
    debug: true
})

app.get('/q', async c => {
  //URLä¸­?åé¢çš„æŸ¥è¯¢å­—ç¬¦ä¸²è§£æåˆ°queryä¸­ã€‚
  //è¿”å›JSONæ–‡æœ¬ï¼Œä¸»è¦åŒºåˆ«åœ¨äºheaderä¸­content-typeä¸ºtext/json
  c.to(c.query)
})

app.post('/p', async c => {
  //POSTã€PUTæäº¤çš„æ•°æ®ä¿å­˜åˆ°bodyï¼Œå¦‚æœæ˜¯è¡¨å•åˆ™ä¼šè‡ªåŠ¨è§£æï¼Œå¦åˆ™åªæ˜¯ä¿å­˜åŸå§‹æ–‡æœ¬å€¼ï¼Œ
  //å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶å¤„ç†å„ç§æ•°æ®ã€‚
  c.to(c.body)
})

app.run(2019)

```

## è·å–POSTæäº¤çš„æ•°æ®

æäº¤è¯·æ±‚ä½“æ•°æ®çš„è¯·æ±‚æ˜¯POSTã€PUTã€‚åœ¨å‰ç«¯é¡µé¢ä¸­ï¼Œä¸€èˆ¬æ˜¯è¡¨å•æäº¤ï¼Œæˆ–è€…æ˜¯å¼‚æ­¥è¯·æ±‚ã€‚

- è¡¨å•æäº¤çš„æ•°æ®è§£æåˆ°c.bodyä¸­ã€‚

> è¡¨å•å¯¹åº”çš„content-typeä¸ºapplication/x-www-form-urlencoded

> å¼‚æ­¥è¯·æ±‚çš„æ•°æ®å¾ˆå¤šæ—¶å€™content-typeæ˜¯applicaiton/json

ä»¥ä¸Šä¸¤ç§ç±»å‹ï¼Œå¯¹åº”çš„c.bodyéƒ½æ˜¯ä¸€ä¸ªobjectã€‚

``` JavaScript
'use strict'

const Topbit = require('topbit')

let app = new Topbit({debug: true})

app.post('/p', async c => {
  //POSTã€PUTæäº¤çš„æ•°æ®ä¿å­˜åˆ°bodyï¼Œå¦‚æœæ˜¯è¡¨å•åˆ™ä¼šè‡ªåŠ¨è§£æä¸ºobjectï¼Œ
  //å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶å¤„ç†å„ç§æ•°æ®ã€‚
  c.to(c.body)
});

app.run(2019)

```

## å…³äºcontent-type

**application/x-www-form-urlencoded**

åŸºæœ¬çš„è¡¨å•ç±»å‹ä¼šè§£æåˆ°c.bodyï¼Œæ˜¯ä¸€ä¸ªJSå¯¹è±¡ã€‚

**text/\***

è‹¥content-typeæ˜¯text/*ï¼Œå°±æ˜¯text/å¼€å¤´çš„ç±»å‹ï¼Œæ¯”å¦‚text/jsonï¼Œæ¡†æ¶å±‚é¢ä¸åšè§£æå¤„ç†ï¼Œä»…ä»…æ˜¯æŠŠä¸Šä¼ æ•°æ®ä»¥utf8ç¼–ç çš„æ ¼å¼è½¬æ¢æˆå­—ç¬¦ä¸²èµ‹å€¼ç»™c.bodyã€‚åç»­çš„å¤„ç†å¼€å‘è€…è‡ªè¡Œå†³å®šã€‚

**multipart/form-data;boundary=xxx**

è‹¥content-typeæ˜¯ä¸Šä¼ æ–‡ä»¶ç±»å‹åˆ™é»˜è®¤ä¼šè§£æï¼Œè§£æåçš„æ–‡ä»¶å¯¹è±¡æ”¾åœ¨c.filesä¸­ï¼Œå¯ä»¥é€šè¿‡c.getFileè·å–ã€‚

**application/json**

è¿™ç§ç±»å‹ä¼šè¿›è¡ŒJSON.parseè§£æã€‚

**å…¶ä»–ç±»å‹**

è‹¥content-typeæ˜¯å…¶ä»–ç±»å‹ï¼Œåˆ™é»˜è®¤åªæ˜¯è®©c.bodyæŒ‡å‘c.rawBodyï¼Œå³ä¸ºæœ€åŸå§‹çš„Bufferæ•°æ®ã€‚

æ¡†æ¶å±‚é¢æä¾›åŸºæœ¬çš„æ ¸å¿ƒçš„æ”¯æŒï¼Œå…¶ä»–ç±»å‹éœ€è¦å¼€å‘å¤„ç†æˆ–è€…æ˜¯ä½¿ç”¨æ‰©å±•ã€‚

è¦æ¯”è¾ƒå®¹æ˜“ä½¿ç”¨ï¼Œä¹Ÿè¦ç•™å‡ºè¶³å¤Ÿçš„ç©ºé—´ç»™å¼€å‘è€…å¤„ç†ï¼Œä½ å¯ä»¥å®Œå…¨æŠ›å¼ƒæ¡†æ¶é»˜è®¤çš„bodyè§£æï¼Œé€šè¿‡åˆå§‹åŒ–é€‰é¡¹parseBodyè®¾ç½®ä¸ºfalseå…³é—­å®ƒã€‚ä¹Ÿå¯ä»¥åœ¨è¿™åŸºç¡€ä¸Šï¼Œè¿›è¡Œæ‰©å±•å¤„ç†ã€‚

bodyè§£ææ¨¡å—æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¿™æ ·è®¾è®¡çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æ‰©å±•å’Œæ›¿æ¢ã€‚

## toå‡½æ•°è¿”å›æ•°æ®

toå‡½æ•°å°±æ˜¯å¯¹c.dataçš„åŒ…è£…ï¼Œå…¶å®å°±æ˜¯è®¾ç½®äº†c.dataçš„å€¼ã€‚å¦å¤–è¿˜æœ‰ä¸¤ä¸ªåˆ«åçš„å‡½æ•°ï¼šokã€ooã€‚æ ¹æ®åœºæ™¯å¯ä»¥è‡ªç”±é€‰æ‹©ã€‚

``` JavaScript

app.get('/', async c => {
  c.to('success')
})

app.get('/randerr', async c => {
  let n = parseInt(Math.random() * 10)
  if (n >= 5) {
    c.ok('success')
  } else {
    //è¿”å›404çŠ¶æ€ç 
    /*
      ç­‰æ•ˆäºï¼š
        c.status(404).data = 'not found'
    */
   //ä½ å¯ä»¥åœ¨v22.4.6ä»¥ä¸Šçš„ç‰ˆæœ¬ä½¿ç”¨é“¾å¼è°ƒç”¨ã€‚
    c.status(404).oo('not found')
  }
})

app.run(1234)

```

## é“¾å¼è°ƒç”¨

å¯ä»¥å¯¹setHeaderã€statusã€sendHeaderä½¿ç”¨é“¾å¼è°ƒç”¨ã€‚

```javascript

app.get('/', async c => {

  c.setHeader('content-type', 'text/plain; charset=utf-8')
    .setHeader('x-server', 'nodejs server')
    .status(200)
    .to(`${Date.now()} Math.random()}`)

})

```

## è·¯ç”±å‚æ•°

``` JavaScript
app.get('/:name/:id', async c => {
  //ä½¿ç”¨:è¡¨ç¤ºè·¯ç”±å‚æ•°ï¼Œè¯·æ±‚å‚æ•°è¢«è§£æåˆ°c.param
  let username = c.param.name;
  let uid = c.param.id;
  c.to(`${username} ${id}`)
})

app.run(8000)
```

## ä»»æ„è·¯å¾„å‚æ•°

\* è¡¨ç¤ºä»»æ„è·¯å¾„ï¼Œä½†æ˜¯å¿…é¡»å‡ºç°åœ¨è·¯ç”±æœ€åã€‚

``` JavaScript

app.get('/static/*', async c => {
  //*è¡¨ç¤ºçš„ä»»æ„è·¯å¾„è§£æåˆ°c.param.starPath
  let spath = c.param.starPath

  c.to(spath)
})

```

----

## è·¯ç”±æŸ¥æ‰¾è§„åˆ™

----

è·¯ç”±æŸ¥æ‰¾è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯å¯¹å¸¦å‚æ•°è·¯ç”±å’Œå¸¦ * çš„è·¯ç”±è¿›è¡Œäº†ä¸¥æ ¼çš„é¡ºåºæ§åˆ¶ï¼Œè€Œä¸æ˜¯æŒ‰ç…§æ·»åŠ é¡ºåºè¿›è¡ŒåŒ¹é…ã€‚

é‡‡ç”¨ä¹‹å‰çš„ç‰ˆæœ¬å¼€å‘çš„åº”ç”¨ä»ç„¶ä¸å—å½±å“ï¼Œä¸å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚æ›´ä¸¥æ ¼çš„é¡ºåºå‡å°‘äº†å†²çªçš„å¯èƒ½ã€‚

è·¯ç”±æŸ¥æ‰¾ç­–ç•¥ï¼š

1. æ™®é€šå­—ç¬¦ä¸²è·¯å¾„ã€‚
2. å¸¦å‚æ•°è·¯ç”±ï¼Œå‚æ•°å°‘çš„è·¯ç”±ä¼šå…ˆåŒ¹é…ã€‚
3. å¸¦ * çš„è·¯ç”±ï¼ŒæŒ‰ç…§æœ€é•¿åˆ°æœ€çŸ­çš„æ¨¡å¼åŒ¹é…ã€‚

```
ç¤ºä¾‹ï¼š
å­˜åœ¨è·¯ç”±ï¼š /x/y/:id  /x/y/* /x/*  /x/:key/:id

/x/y/123 å…ˆåŒ¹é… /x/y/:idï¼Œä¸ä¼šç»§ç»­åŒ¹é…ã€‚

/x/y/123/345 å…ˆåŒ¹é…åˆ° /x/y/*ï¼Œä¸ä¼šç»§ç»­åŒ¹é…ã€‚

/x/q/123 ä¼šåŒ¹é…åˆ° /x/:key/:idã€‚

/x/a.jpg ä¼šåŒ¹é…åˆ° /x/*ï¼Œå…¶ä»–è·¯ç”±éƒ½æ— æ³•åŒ¹é…ã€‚

/x/static/images/a.jpg ä¼šåŒ¹é…åˆ° /x/*ï¼Œå…¶ä»–è·¯ç”±éƒ½æ— æ³•åŒ¹é…ã€‚

```

----

## åˆ†ç»„æ·»åŠ è·¯ç”±

ä½ å¯ä»¥ä½¿ç”¨app.middlewareæŒ‡å®šä¸­é—´ä»¶å¹¶ä½¿ç”¨è¿”å›çš„groupæ–¹æ³•æ·»åŠ åˆ†ç»„è·¯ç”±ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨app.groupåˆ†ç»„æ·»åŠ è·¯ç”±ã€‚

**topbit.prototype.middleware(mids, options=null)**

- midsæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°æˆ–ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸­é—´ä»¶ï¼Œç¬¬äºŒä¸ªæ˜¯æ·»åŠ ä¸­é—´ä»¶çš„é€‰é¡¹ã€‚

- optionsé»˜è®¤ä¸ºnullï¼Œä¼ é€’ä¸€ä¸ªobjectä¸ºé’ˆå¯¹æ‰€æœ‰midsçš„é€‰é¡¹ï¼Œæ¯”å¦‚{pre: true}

**topbit.prototype.group(group_name, callback, prefix=true)**

- group_name æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºè·¯ç”±åˆ†ç»„çš„åç§°ï¼Œå¦‚æœæ˜¯åˆæ³•çš„è·¯å¾„ï¼Œä¹Ÿä½œä¸ºè·¯ç”±çš„å‰ç¼€ã€‚

- callback å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°æ¥æ”¶çš„å‚æ•°ä»ç„¶å¯ä»¥è°ƒç”¨middlewareå’Œgroupï¼ŒåŒæ—¶å¯ä»¥è°ƒç”¨getã€postç­‰æ–¹æ³•æ·»åŠ è·¯ç”±ã€‚

- prefix å¸ƒå°”å€¼ï¼Œé»˜è®¤ä¸ºtrueï¼Œç”¨äºæ§åˆ¶group_nameæ˜¯å¦æ·»åŠ ä¸ºè·¯ç”±çš„å‰ç¼€ï¼Œä¸è¿‡åªæœ‰åœ¨group_nameä¸ºåˆæ³•çš„è·¯ç”±å­—ç¬¦ä¸²æ‰ä¼šä½œä¸ºå‰ç¼€ã€‚


```javascript
'use strict'

const Topbit = require('topbit')

const app = new Topbit({
  debug: true
})

//ä¸­é—´ä»¶å‡½æ•°
let mid_timing = async (c, next) => {
  console.time('request')
  await next(c)
  console.timeEnd('request')
}

//groupè¿”å›å€¼å¯ä»¥ä½¿ç”¨useã€preæ·»åŠ ä¸­é—´ä»¶ã€‚
// /apiåŒæ—¶ä¼šæ·»åŠ åˆ°è·¯ç”±çš„å‰ç¼€ã€‚
app.group('/api', route => {
  route.get('/test', async c => {
    c.to('api test')
  })

  route.get('/:name', async c => {
    c.to(c.param)
  })
})

//æ·»åŠ ä¸­é—´ä»¶åˆ°å¯¹åº”åˆ†ç»„
app.use(
  async (c, next) => {
    console.log(c.method, c.headers)
    await next(c)
  }, {group: '/sub'}
).group('/sub', route => {
  route.get('/:id', async c => {
    c.to(c.param.id)
  })
})

//æµ‹è¯• ä¸ç¬¦åˆ è·¯ç”±è§„åˆ™ï¼Œæ‰€ä»¥ä¸ä¼šä½œä¸ºè·¯å¾„çš„å‰ç¼€ã€‚
app.group('æµ‹è¯•', route => {
  route.get('/test', async c => {
    console.log(c.group, c.name)
    c.to('test ok')
  }, 'test')
})

app.run(1234)

```

ä»¥ä¸Šè¿™ç§æ–¹å¼åœ¨æŒ‡å®šå¤šä¸ªä¸­é—´ä»¶çš„æ—¶å€™ä¼šæœ‰äº›å¤æ‚ï¼Œå¯ä»¥ä½¿ç”¨middlewareæ–¹æ³•ã€‚å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ã€‚

### ç»™åˆ†ç»„å’Œå­åˆ†ç»„æŒ‡æ´¾ä¸­é—´ä»¶

```javascript
'use strict'

const Topbit = require('topbit')
//å¯¼å…¥ToFileæ‰©å±•
const {ToFile} = Topbit.extensions

const app = new Topbit({
  debug: true
})

//ä¸­é—´ä»¶å‡½æ•°
let mid_timing = async (c, next) => {
  console.time('request')
  await next(c)
  console.timeEnd('request')
}

let sub_mid_test = async (c, next) => {
  console.log('mid test start')
  await next(c)
  console.log('mid test end')
}

//groupè¿”å›å€¼å¯ä»¥ä½¿ç”¨useã€preã€middlewareæ·»åŠ ä¸­é—´ä»¶ã€‚
// /apiåŒæ—¶ä¼šæ·»åŠ åˆ°è·¯ç”±çš„å‰ç¼€ã€‚

app.middleware([
     //è€—æ—¶è®°å½•ä¸­é—´ä»¶ï¼Œåœ¨æ¥æ”¶è¯·æ±‚ææ•°æ®ä¹‹å‰è¿›è¡Œï¼Œæ‰€ä»¥preè®¾ç½®ä¸ºtrue
     [ mid_timing, {pre: true} ],

     //ToFileæ‰©å±•åœ¨æ¥æ”¶è¯·æ±‚ä½“æ•°æ®ä¹‹åè¿è¡Œï¼Œå¹¶ä¸”åªé’ˆå¯¹POSTå’ŒPUTè¯·æ±‚æ‰§è¡Œ
     [ new ToFile(), {method: ['POST', 'PUT']} ]
  ])
  .group('/api', route => {
      route.get('/test', async c => {
        c.to('api test')
      })

      route.get('/:name', async c => {
        c.to(c.param)
      })

      //å­åˆ†ç»„ /subå¯ç”¨ä¸­é—´ä»¶sub_mid_testï¼ŒåŒæ—¶ï¼Œå­åˆ†ç»„ä¼šå¯ç”¨ä¸Šä¸€å±‚çš„æ‰€æœ‰ä¸­é—´ä»¶ã€‚
      route.middleware([sub_mid_test])
        .group('/sub', sub => {
            sub.get('/:key', async c => {
              c.to(c.param)
            })
        })
  })

app.run(1234)

```

åˆ†ç»„æ”¯æŒåµŒå¥—è°ƒç”¨ï¼Œä½†æ˜¯å±‚çº§ä¸èƒ½è¶…è¿‡9ã€‚é€šå¸¸è¶…è¿‡3å±‚çš„åµŒå¥—åˆ†ç»„å°±æ˜¯æœ‰é—®é¢˜çš„ï¼Œéœ€è¦é‡æ–°è®¾è®¡ã€‚

**è¿™ä¸ªåŠŸèƒ½ï¼Œä¸å¦‚TopbitLoaderæ‰©å±•çš„è‡ªåŠ¨åŠ è½½æœºåˆ¶æ–¹ä¾¿æ˜“ç”¨ï¼Œä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸­ã€‚æœ‰å„ç§å„æ ·çš„éœ€æ±‚ã€‚å¹¶ä¸”æœ‰æ—¶å€™ä¸å¾—ä¸åˆ©ç”¨å•æ–‡ä»¶åšæœåŠ¡ï¼ŒåŒæ—¶è¿˜è¦èƒ½å¤Ÿå…¼é¡¾æ¡†æ¶æœ¬èº«çš„è·¯ç”±å’Œä¸­é—´ä»¶åˆ†ç»„çš„ä¼˜åŠ¿ï¼Œè¿˜è¦èƒ½å¤Ÿæ–¹ä¾¿çš„ç¼–å†™é€»è¾‘æ˜ç¡®ï¼Œç»“æ„æ¸…æ™°çš„ä»£ç ï¼Œå› æ­¤middlewareã€groupçš„æ¥å£åŠŸèƒ½å¯ä»¥æ–¹ä¾¿å¤„ç†ï¼Œå¹¶ä¸”è‹¥ä¸ä¹ æƒ¯TopbitLoaderçš„MCMæ¨¡å¼(Middleware - Controller - Modelï¼Œç±»ä¼¼MVCçš„æ¨¡å¼)ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹å¼ä¹Ÿå¯ä»¥å¾ˆå¥½çš„ç»„åˆå…¶ä»–æ¨¡å—ä»£ç ã€‚**

ä»¥ä¸Šè·¯ç”±æŒ‡æ´¾åˆ†ç»„çš„åŠŸèƒ½æ˜¯éä¾µå…¥å¼çš„ï¼Œå®ƒä¸ä¼šå½±å“å·²æœ‰ä»£ç ï¼Œä¹Ÿä¸ä¼šå’ŒTopbitLoaderå†²çªã€‚

**!! å¤æ‚çš„è·¯ç”±å¤„ç†å‡½æ•°åº”è¯¥æ”¾åœ¨å•ç‹¬çš„æ¨¡å—ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„è‡ªåŠ¨åŒ–åŠ è½½å‡½æ•°æ¥å®Œæˆã€‚**

æ”¯æŒä½¿ç”¨è¿”å›å€¼è¿›è¡Œæ·»åŠ ï¼Œä¹Ÿå¯ä»¥ä¸å¿…ä¼ é€’å›è°ƒå‡½æ•°ï¼š

```javascript
'use strict'

const Topbit = require('topbit')
//å¯¼å…¥ToFileæ‰©å±•
const {ToFile} = Topbit.extensions

const app = new Topbit({
  debug: true
})

//ä¸­é—´ä»¶å‡½æ•°
let mid_timing = async (c, next) => {
  console.time('request')
  await next(c)
  console.timeEnd('request')
}

let sub_mid_test = async (c, next) => {
  console.log('mid test start')
  await next(c)
  console.log('mid test end')
}

let route = app.middleware([
                //è€—æ—¶è®°å½•ä¸­é—´ä»¶ï¼Œåœ¨æ¥æ”¶è¯·æ±‚ææ•°æ®ä¹‹å‰è¿›è¡Œï¼Œæ‰€ä»¥preè®¾ç½®ä¸ºtrue
                [ mid_timing, {pre: true} ],

                //ToFileæ‰©å±•åœ¨æ¥æ”¶è¯·æ±‚ä½“æ•°æ®ä¹‹åè¿è¡Œï¼Œå¹¶ä¸”åªé’ˆå¯¹POSTå’ŒPUTè¯·æ±‚æ‰§è¡Œ
                [ new ToFile(), {method: ['POST', 'PUT']} ]
              ])
              .group('/api')

route.get('/test', async c => {
  c.to('api test')
})

route.get('/:name', async c => {
  c.to(c.param)
})

//å­åˆ†ç»„ /subå¯ç”¨ä¸­é—´ä»¶sub_mid_testï¼ŒåŒæ—¶ï¼Œå­åˆ†ç»„ä¼šå¯ç”¨ä¸Šä¸€å±‚çš„æ‰€æœ‰ä¸­é—´ä»¶ã€‚
route.middleware([sub_mid_test])
  .group('/sub', sub => {
      sub.get('/:key', async c => {
        c.to(c.param)
      })
  })

app.run(1234)

```

----

## ä¸Šä¼ æ–‡ä»¶

é»˜è®¤ä¼šè§£æä¸Šä¼ çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨åˆå§‹åŒ–æœåŠ¡çš„æ—¶å€™ï¼Œä¼ é€’parseBodyé€‰é¡¹å…³é—­å®ƒï¼Œå…³äºé€‰é¡¹åé¢æœ‰è¯¦ç»†çš„è¯´æ˜ã€‚
è§£æåçš„æ–‡ä»¶æ•°æ®åœ¨c.filesä¸­å­˜å‚¨ï¼Œå…·ä½“ç»“æ„åœ¨åé¢æœ‰å±•ç¤ºã€‚

``` JavaScript
'use strict'

const Topbit = require('topbit')

const app = new Topbit()

app.post('/upload', async c => {
  
  let f = c.getFile('image')

  //æ ¹æ®åŸå§‹æ–‡ä»¶åè§£ææ‰©å±•åå¹¶ç”Ÿæˆæ—¶é—´æˆ³åŠ éšæœºæ•°çš„å”¯ä¸€æ–‡ä»¶åã€‚

  let fname = c.ext.makeName(f.filename)

  try {
    c.to(await c.moveFile(f, fname))
  } catch (err) {
    c.status(500).to(err.message)
  }
  
}, 'upload-image'); //ç»™è·¯ç”±å‘½åä¸ºupload-imageï¼Œå¯ä»¥åœ¨c.nameä¸­è·å–ã€‚

app.run(1234)

```

## c.filesæ•°æ®ç»“æ„

è¿™ç§ç»“æ„æ˜¯æ ¹æ®HTTPåè®®ä¸Šä¼ æ–‡ä»¶æ—¶çš„æ•°æ®æ„é€ è®¾è®¡çš„ï¼ŒHTTPåè®®å…è®¸åŒä¸€ä¸ªä¸Šä¼ åæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥è¦è§£ææˆä¸€ä¸ªæ•°ç»„ã€‚è€Œä½¿ç”¨getFileé»˜è®¤æƒ…å†µåªè¿”å›ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œå› ä¸ºå¤šæ•°æƒ…å†µåªæ˜¯ä¸€ä¸ªä¸Šä¼ åå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ã€‚

> å¯¹äºå‰ç«¯æ¥è¯´ï¼Œä¸Šä¼ åå°±æ˜¯ä½ åœ¨HTMLä¸­è¡¨å•çš„nameå±æ€§ï¼š&lt;input type="file" name="image"&gt;
> imageæ˜¯ä¸Šä¼ åï¼Œä¸è¦æŠŠä¸Šä¼ åå’Œæ–‡ä»¶åæ··æ·†ã€‚


```

{
  image : [
    {
      type: CONTENT_TYPE,
      filename: ORIGIN_FILENAME,
      start : START,
      end   : END,
      length: LENGTH,
      rawHeader: HEADER_DATA,
      headers: {...}
    },
    ...
  ],

  video : [
    {
      type: CONTENT_TYPE,
      filename: ORIGIN_FILENAME,
      start : START,
      end   : END,
      length: LENGTH,
      rawHeader: HEADER_DATA,
      headers: {...}
    },
    ...
  ]
}
```

c.getFileå°±æ˜¯é€šè¿‡åç§°ç´¢å¼•ï¼Œé»˜è®¤ç´¢å¼•å€¼æ˜¯0ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå°äº0çš„æ•°å­—ï¼Œåˆ™ä¼šè·å–æ•´ä¸ªæ–‡ä»¶æ•°ç»„ï¼Œæ²¡æœ‰è¿”å›nullã€‚


## bodyæœ€å¤§æ•°æ®é‡é™åˆ¶

```javascript
'use strict'

const Topbit = require('topbit')

const app = new Topbit({
  //å…è®¸POSTæˆ–PUTè¯·æ±‚æäº¤çš„æ•°æ®é‡æœ€å¤§å€¼ä¸ºå°†è¿‘20Mã€‚
  //å•ä½ä¸ºå­—èŠ‚ã€‚
  maxBody: 20000000
})

//...

app.run(1234)

```


## ä¸­é—´ä»¶

ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ¨¡å¼ï¼Œä¸åŒè¯­è¨€å®ç°èµ·æ¥å¤šå°‘è¿˜æ˜¯æœ‰äº›åŒºåˆ«çš„ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ã€‚ä¸­é—´ä»¶çš„è¿è¡Œæœºåˆ¶å…è®¸å¼€å‘è€…æ›´å¥½çš„ç»„ç»‡ä»£ç ï¼Œæ–¹ä¾¿å®ç°å¤æ‚çš„é€»è¾‘éœ€æ±‚ã€‚äº‹å®ä¸Šï¼Œæ•´ä¸ªæ¡†æ¶çš„è¿è¡Œæœºåˆ¶éƒ½æ˜¯ä¸­é—´ä»¶æ¨¡å¼ã€‚

ä¸­é—´ä»¶å›¾ç¤ºï¼š

![](images/middleware.jpg)

æ­¤æ¡†æ¶çš„ä¸­é—´ä»¶åœ¨è®¾è®¡å±‚é¢ä¸Šï¼ŒæŒ‰ç…§è·¯ç”±åˆ†ç»„åŒºåˆ†ï¼Œä¹Ÿå¯ä»¥è¯†åˆ«ä¸åŒè¯·æ±‚ç±»å‹ï¼Œç¡®å®šæ˜¯å¦æ‰§è¡Œè¿˜æ˜¯è·³è¿‡åˆ°ä¸‹ä¸€å±‚ï¼Œæ‰€ä»¥é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”å¤šä¸ªè·¯ç”±å’Œåˆ†ç»„éƒ½å…·å¤‡è‡ªå·±çš„ä¸­é—´ä»¶ï¼Œç›¸äº’ä¸å†²çªï¼Œä¹Ÿä¸ä¼šæœ‰æ— æ„ä¹‰çš„è°ƒç”¨ã€‚å‚è€ƒå½¢å¼å¦‚ä¸‹ï¼š

``` JavaScript

/*
  ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥ä¸å¡«å†™ï¼Œè¡¨ç¤ºå…¨å±€å¼€å¯ä¸­é—´ä»¶ã€‚
  ç°åœ¨ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºï¼šåªå¯¹POSTè¯·æ±‚æ–¹æ³•æ‰ä¼šæ‰§è¡Œï¼Œå¹¶ä¸”è·¯ç”±åˆ†ç»„å¿…é¡»æ˜¯/apiã€‚
  åŸºäºè¿™æ ·çš„è®¾è®¡ï¼Œå¯ä»¥ä¿è¯æŒ‰éœ€æ‰§è¡Œï¼Œä¸åšå¤ªå¤šæ— æ„ä¹‰çš„æ“ä½œã€‚
*/
app.add(async (c, next) => {
    console.log('before');
    await next(c);
    console.log('after');
}, {method: 'POST', group: '/api'});

```

ä½¿ç”¨addæ·»åŠ çš„ä¸­é—´ä»¶æ˜¯æŒ‰ç…§æ·»åŠ é¡ºåºé€†åºæ‰§è¡Œï¼Œè¿™æ˜¯æ ‡å‡†çš„æ´‹è‘±æ¨¡å‹ã€‚ä¸ºäº†æä¾›å®¹æ˜“ç†è§£çš„é€»è¾‘ï¼Œæä¾›useæ¥å£æ·»åŠ ä¸­é—´ä»¶ï¼Œä½¿ç”¨useæ·»åŠ çš„ä¸­é—´ä»¶æŒ‰ç…§æ·»åŠ é¡ºåºæ‰§è¡Œã€‚ä¸åŒçš„æ¡†æ¶å¯¹å®ç°é¡ºåºçš„é€»è¾‘å¾€å¾€ä¼šä¸åŒï¼Œä½†æ˜¯é¡ºåºæ‰§è¡Œæ›´ç¬¦åˆå¼€å‘è€…ä¹ æƒ¯ã€‚

**å»ºè®®åªä½¿ç”¨useæ¥æ·»åŠ ä¸­é—´ä»¶ï¼š**

``` JavaScript
//å…ˆæ‰§è¡Œ
app.use(async (c, next) => {
  let start_time = Date.now()
  await next(c)
  let end_time = Date.now()
  console.log(end_time - start_time)
})

//åæ‰§è¡Œ
app.use(async (c, next) => {
  console.log(c.method, c.path)
  await next(c)
})

//useå¯ä»¥çº§è”: app.use(m1).use(m2)

```

## topbitå®Œæ•´çš„æµç¨‹å›¾ç¤º

![](images/topbit-middleware.webp)


> **éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œå…¶å®åœ¨å†…éƒ¨ï¼Œbodyæ•°æ®æ¥æ”¶å’Œè§£æä¹Ÿéƒ½æ˜¯ä¸­é—´ä»¶ï¼Œåªæ˜¯åˆ»æ„å®‰æ’äº†é¡ºåºï¼Œåˆ†å‡ºäº†preå’Œuseæ¥å£ã€‚**


## ä¸­é—´ä»¶å‚æ•°

ä½¿ç”¨useæˆ–è€…preæ¥å£æ·»åŠ ä¸­é—´ä»¶ï¼Œè¿˜æ”¯æŒç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥è¿›è¡Œç²¾ç¡®çš„æ§åˆ¶ï¼Œä¼ é€’é€‰é¡¹å±æ€§ï¼š

* group  è·¯ç”±åˆ†ç»„ï¼Œè¡¨ç¤ºé’ˆå¯¹å“ªä¸ªåˆ†ç»„æ‰§è¡Œã€‚

* method è¯·æ±‚æ–¹æ³•ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼Œå¿…é¡»å¤§å†™ã€‚

* name  è¯·æ±‚åç§°ï¼Œè¡¨ç¤ºåªé’ˆå¯¹æ­¤è¯·æ±‚æ‰§è¡Œã€‚

ç¤ºä¾‹ï¼š

```javascript

app.get('/xyz', async c => {
  //...
  //è·¯ç”±åˆ†ç»„å‘½åä¸ºproxy
}, {group: 'proxy'})

app.use(proxy, {
  method : ['PUT', 'POST', 'GET', 'DELETE', 'OPTIONS'],
  //é’ˆå¯¹è·¯ç”±åˆ†ç»„proxyçš„è¯·æ±‚æ‰§è¡Œã€‚
  group : 'proxy'
})
```


## pre åœ¨æ¥æ”¶bodyæ•°æ®ä¹‹å‰

ä½¿ç”¨preæ¥å£æ·»åŠ çš„ä¸­é—´ä»¶å’Œuseæ·»åŠ çš„ä¸»è¦åŒºåˆ«å°±æ˜¯ä¼šåœ¨æ¥æ”¶bodyæ•°æ®ä¹‹å‰æ‰§è¡Œã€‚å¯ç”¨äºåœ¨æ¥æ”¶æ•°æ®ä¹‹å‰çš„æƒé™è¿‡æ»¤æ“ä½œã€‚å…¶å‚æ•°å’Œuseä¸€è‡´ã€‚

ä¸ºäº†ä¸€è‡´çš„å¼€å‘ä½“éªŒï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨useæ¥å£ï¼Œåªéœ€è¦åœ¨é€‰é¡¹ä¸­é€šè¿‡preæŒ‡å®šï¼š

```javascript
let setbodysize = async (c, next) => {
    //è®¾å®šbodyæœ€å¤§æ¥æ”¶æ•°æ®ä¸º~10kã€‚
    c.maxBody = 10000;
    await next(c);
};

//ç­‰æ•ˆäºapp.pre(setbodysize);
app.use(setbodysize, {pre: true});

```

ä½¿ç”¨preå¯ä»¥è¿›è¡Œæ›´å¤æ‚çš„å¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥æ‹¦æˆªå¹¶ä¸æ‰§è¡Œä¸‹ä¸€å±‚ï¼Œæ¯”å¦‚topbit-toolkitæ‰©å±•çš„proxyæ¨¡å—åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ç›´æ¥å®ç°äº†é«˜æ€§èƒ½çš„ä»£ç†æœåŠ¡ï¼Œä½†æ˜¯ä»…ä»…ä½œä¸ºæ¡†æ¶çš„ä¸€ä¸ªä¸­é—´ä»¶ã€‚å…¶ä¸»è¦æ“ä½œå°±æ˜¯åœ¨è¿™ä¸€å±‚ï¼Œç›´æ¥è®¾ç½®äº†requestçš„dataäº‹ä»¶æ¥æ¥æ”¶æ•°æ®ï¼Œå¹¶ä½œå…¶ä»–å¤„ç†ï¼Œä¹‹åç›´æ¥è¿”å›ã€‚

**æ ¹æ®ä¸åŒçš„è¯·æ±‚ç±»å‹åŠ¨æ€é™åˆ¶è¯·æ±‚ä½“å¤§å°**

è¿™ä¸ªéœ€æ±‚å¯ä»¥é€šè¿‡preæ·»åŠ ä¸­é—´ä»¶è§£å†³ï¼š

```javascript

const app = new Topbit({
  //é»˜è®¤æœ€å¤§è¯·æ±‚ä½“ ~10M é™åˆ¶ã€‚
  maxBody: 10000000
})

app.pre(async (c, next) => {

  let ctype = c.headers['content-type'] || ''

  if (ctype.indexOf('text/') === 0) {
    //50K
    c.maxBody = 50000
  } else if (ctype.indexOf('application/') === 0) {
    //100K
    c.maxBody = 100000
  } else if (ctype.indexOf('multipart/form-data') < 0) {
    //10K
    c.maxBody = 10000
  }

  await next(c)

}, {method: ['POST', 'PUT']})


```

è¿™äº›å‚æ•°è‹¥åŒæ—¶å‡ºç°åœ¨æ–‡ä»¶é‡Œä¼šæ˜¾å¾—å¾ˆå¤æ‚ï¼Œç»´æŠ¤ä¹Ÿä¸æ–¹ä¾¿ï¼Œä½†æ˜¯åŠŸèƒ½å¾ˆå¼ºï¼Œæ‰€ä»¥è‹¥è¦äº¤ç»™ç¨‹åºè‡ªåŠ¨å®Œæˆåˆ™å¯ä»¥å¤§å¤§ç®€åŒ–ç¼–ç çš„å·¥ä½œã€‚

**å®Œæ•´çš„é¡¹ç›®ç»“æ„æ­å»ºï¼Œè¯·é…åˆä½¿ç”¨topbit-loaderï¼Œæ­¤æ‰©å±•å®Œæˆäº†è·¯ç”±ã€æ¨¡å‹çš„è‡ªåŠ¨åŠ è½½å’Œä¸­é—´ä»¶è‡ªåŠ¨ç¼–æ’ã€‚<a target=_blank href="https://gitee.com/daoio/topbit-loader">topbit-loader</a>**


## HTTPS

```javascript
'use strict'

const Topbit = require('topbit')

//åªéœ€è¦ä¼ é€’è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶æ‰€åœ¨è·¯å¾„
const app = new Topbit({
    // './xxx.pem'æ–‡ä»¶ä¹Ÿå¯ä»¥
    cert: './xxx.cert',
    key: './xxx.key'
})

app.run(1234)

```

## åŒæ—¶æ”¯æŒHTTP/2å’ŒHTTP/1.1(å…¼å®¹æ¨¡å¼)

å…¼å®¹æ¨¡å¼æ˜¯åˆ©ç”¨ALPNåè®®ï¼Œéœ€è¦ä½¿ç”¨HTTPSæ‰å¯ä»¥ï¼Œæ‰€ä»¥å¿…é¡»è¦é…ç½®è¯ä¹¦å’Œå¯†é’¥ã€‚

```javascript
'use strict'

const Topbit = require('topbit')

//åªéœ€è¦ä¼ é€’è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶æ‰€åœ¨è·¯å¾„
const app = new Topbit({
    cert: './xxx.cert',
    key: './xxx.key',
    //å¯ç”¨http2å¹¶å…è®¸http1ï¼Œä¼šè‡ªåŠ¨å¯ç”¨å…¼å®¹æ¨¡å¼
    http2: true,
    allowHTTP1: true
})

app.run(1234)

```


## é…ç½®é€‰é¡¹

åº”ç”¨åˆå§‹åŒ–ï¼Œå®Œæ•´çš„é…ç½®é€‰é¡¹å¦‚ä¸‹ï¼Œè¯·ä»”ç»†é˜…è¯»æ³¨é‡Šè¯´æ˜ã€‚

``` JavaScript
  {
    //æ­¤é…ç½®è¡¨ç¤ºPOST/PUTæäº¤è¡¨å•çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œä¹Ÿæ˜¯ä¸Šä¼ æ–‡ä»¶çš„æœ€å¤§é™åˆ¶ã€‚
    maxBody   : 8000000,

    //æœ€å¤§è§£æçš„æ–‡ä»¶æ•°é‡
    maxFiles      : 12,

    daemon        : false, //å¼€å¯å®ˆæŠ¤è¿›ç¨‹

    /*
      å¼€å¯å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼åï¼Œå¦‚æœè®¾ç½®è·¯å¾„ä¸ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™ä¼šæŠŠpidå†™å…¥åˆ°æ­¤æ–‡ä»¶ï¼Œå¯ç”¨äºæœåŠ¡ç®¡ç†ã€‚
    */
    pidFile       : '',

    //æ˜¯å¦å¼€å¯å…¨å±€æ—¥å¿—ï¼Œtrueè¡¨ç¤ºå¼€å¯ï¼Œè¿™æ—¶å€™ä¼šæŠŠè¯·æ±‚ä¿¡æ¯è¾“å‡ºæˆ–è€…å†™å…¥åˆ°æ–‡ä»¶
    globalLog: false,

    //æ—¥å¿—è¾“å‡ºæ–¹å¼ï¼šstdioè¡¨ç¤ºè¾“å‡ºåˆ°ç»ˆç«¯ï¼Œfileè¡¨ç¤ºè¾“å‡ºåˆ°æ–‡ä»¶
    logType : 'stdio',

    //æ­£ç¡®è¯·æ±‚æ—¥å¿—è¾“å‡ºçš„æ–‡ä»¶è·¯å¾„
    logFile : '',

    //é”™è¯¯è¯·æ±‚æ—¥å¿—è¾“å‡ºçš„æ–‡ä»¶è·¯å¾„
    errorLogFile : '',

    //æ—¥å¿—æ–‡ä»¶æœ€å¤§æ¡æ•°
    logMaxLines: 50000,

    //æœ€å¤§å†å²æ—¥å¿—æ–‡ä»¶æ•°é‡
    logHistory: 50,

    //è‡ªå®šä¹‰æ—¥å¿—å¤„ç†å‡½æ•°
    logHandle: null,

    //å¼€å¯HTTPS
    https       : false,

    http2   : false,

    allowHTTP1: false,

    //HTTPSå¯†é’¥å’Œè¯ä¹¦çš„æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœè®¾ç½®äº†è·¯å¾„ï¼Œåˆ™ä¼šè‡ªåŠ¨è®¾ç½®httpsä¸ºtrueã€‚
    key   : '',
    cert  : '',

    //æœåŠ¡å™¨é€‰é¡¹éƒ½å†™åœ¨serverä¸­ï¼Œåœ¨åˆå§‹åŒ–httpæœåŠ¡æ—¶ä¼šä¼ é€’ï¼Œå‚è€ƒhttp2.createSecureServerã€tls.createServer
    server : {
      handshakeTimeout: 8192, //TLSæ¡æ‰‹è¿æ¥ï¼ˆHANDSHAKEï¼‰è¶…æ—¶
      //sessionTimeout: 350,
    },

    //è®¾ç½®æœåŠ¡å™¨è¶…æ—¶ï¼Œæ¯«ç§’å•ä½ï¼Œåœ¨å…·ä½“çš„è¯·æ±‚ä¸­ï¼Œå¯ä»¥å†è®¾ç½®è¯·æ±‚çš„è¶…æ—¶ã€‚
    timeout   : 15000,

    debug     : false,

    //å¿½ç•¥è·¯å¾„æœ«å°¾çš„ /
    ignoreSlash: true,

    //å¯ç”¨è¯·æ±‚é™åˆ¶
    useLimit: false,

    //æœ€å¤§è¿æ¥æ•°ï¼Œ0è¡¨ç¤ºä¸é™åˆ¶
    maxConn : 1024,

    //å•ä¸ªIPå•ä½æ—¶é—´å†…çš„æœ€å¤§è¿æ¥æ•°ï¼Œ0è¡¨ç¤ºä¸é™åˆ¶
    maxIPRequest: 0,

    //é’ˆå¯¹IPçš„é™æµå•ä½æ—¶é—´ï¼Œ1è¡¨ç¤º1ç§’ï¼Œé»˜è®¤ä¸º60ç§’ï¼Œ0.1 ~ 86400
    unitTime : 60,
    
    //å±•ç¤ºè´Ÿè½½ä¿¡æ¯ï¼Œéœ€è¦é€šè¿‡daemonæ¥å£å¼€å¯clusteré›†ç¾¤æ¨¡å¼
    loadMonitor : true,

    //è´Ÿè½½ä¿¡æ¯çš„ç±»å‹ï¼Œtext ã€null, obj, orgobj
    //jsonç±»å‹æ˜¯ç»™ç¨‹åºé€šä¿¡ä½¿ç”¨çš„ï¼Œæ–¹ä¾¿æ¥å£å¼€å‘
    loadInfoType : 'text',

    //è´Ÿè½½ä¿¡æ¯çš„æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸è®¾ç½®åˆ™è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œå¦åˆ™ä¿å­˜åˆ°æ–‡ä»¶
    loadInfoFile : '',

    //404è¦è¿”å›çš„æ•°æ®
    notFound: 'Not Found',
    
    //400è¦è¿”å›çš„æ•°æ®
    badRequest : 'Bad Request',

    //æ§åˆ¶å­è¿›ç¨‹æœ€å¤§å†…å­˜ä½¿ç”¨é‡çš„ç™¾åˆ†æ¯”å‚æ•°ï¼ŒèŒƒå›´ä»-0.42 ï½ 0.36ã€‚åŸºç¡€æ•°å€¼æ˜¯0.52ï¼Œæ‰€ä»¥é»˜è®¤å€¼ç™¾åˆ†æ¯”ä¸º80%ã€‚
    memFactor: 0.28,

    //urlæœ€å¤§é•¿åº¦
    maxUrlLength: 2048,

    //è¯·æ±‚ä¸Šä¸‹æ–‡ç¼“å­˜æ± æœ€å¤§æ•°é‡ã€‚
    maxpool: 4096,

    //å­è¿›ç¨‹æ±‡æŠ¥èµ„æºä¿¡æ¯çš„å®šæ—¶å™¨æ¯«ç§’æ•°ã€‚
    monitorTimeSlice: 640,

    //åœ¨globalLogä¸ºtrueæ—¶ï¼Œå…¨å±€æ—¥å¿—æ˜¯å¦è®°å½•çœŸå®çš„IPåœ°å€ï¼Œä¸»è¦ç”¨åœ¨åå‘ä»£ç†æ¨¡å¼ä¸‹ã€‚
    realIP: false,

    //å…è®¸çš„æœ€å¤§querystringå‚æ•°ä¸ªæ•°ã€‚
    maxQuery: 25,

    //æ˜¯å¦å¯ç”¨strongæ¨¡å¼ï¼Œå¯ç”¨åä¼šä½¿ç”¨processå¤„ç†rejectionHandled å’Œ uncaughtExceptionäº‹ä»¶ï¼Œ
    //å¹¶æ•è·ä¸€äº›é”™è¯¯ï¼šTypeError,ReferenceError,RangeError,AssertionError,URIError,Errorã€‚
    strong: false,

    //å¿«é€Ÿè§£æquerystringï¼Œå¤šä¸ªåŒåçš„å€¼ä¼šä»…è®¾ç½®ç¬¬ä¸€ä¸ªï¼Œä¸ä¼šè§£ææˆæ•°ç»„ã€‚
    fastParseQuery: false,
    
    //æ˜¯å¦è‡ªåŠ¨è§£ç Queryå‚æ•°ï¼Œä¼šè°ƒç”¨decodeURIComponentå‡½æ•°ã€‚
    autoDecodeQuery: true,

    //åœ¨multipartæ ¼å¼ä¸­ï¼Œé™åˆ¶å•ä¸ªè¡¨å•é¡¹çš„æœ€å¤§é•¿åº¦ã€‚
    maxFormLength: 1000000,

    /* é”™è¯¯å¤„ç†å‡½æ•°ï¼Œæ­¤å‡½æ•°ç»Ÿä¸€æ”¶é›†æœåŠ¡è¿è¡Œæ—¶å‡ºç°çš„
          tlsClientErrorã€æœåŠ¡å™¨errorã€secureConnectioné”™è¯¯ã€clientErrorã€è¿è¡Œæ—¶çš„æŠ›å‡ºé”™è¯¯ã€‚
      errnameæ˜¯ä¸€ä¸ªæ ‡è®°é”™è¯¯ä¿¡æ¯å’Œå‡ºç°ä½ç½®çš„å­—ç¬¦ä¸²ï¼Œç»Ÿä¸€æ ¼å¼ä¸º--ERR-CONNECTION--ã€--ERR-CLIENT--è¿™ç§å½¢å¼ã€‚

      é€šå¸¸Node.jsæŠ›å‡ºé”™è¯¯ä¼šæœ‰codeå’Œmessageç­‰ä¿¡æ¯æ–¹ä¾¿è¯†åˆ«å’Œæ’æŸ¥ï¼Œä¹Ÿä¸æ’é™¤æœ‰æŠ›å‡ºé”™è¯¯æ²¡æœ‰codeçš„æƒ…å†µï¼Œ
        errnameå¯ç”¨å¯ä¸ç”¨ï¼Œä½†æ˜¯å‚æ•°ä¼šè¿›è¡Œä¼ é€’ã€‚
      é€šè¿‡é…ç½®é€‰é¡¹ä¼ é€’è‡ªå®šå‡½æ•°å³å¯å®ç°è‡ªå®šä¹‰é”™è¯¯æ”¶é›†å’Œå¤„ç†æ–¹å¼ã€‚
    */
    errorHandle: (err, errname) => {
      this.config.debug && console.error(errname, err)
    },

    //æœ€å¤§è´Ÿè½½ç‡ç™¾åˆ†æ¯”ï¼Œé»˜è®¤ä¸º75è¡¨ç¤ºå½“CPUä½¿ç”¨ç‡è¶…è¿‡75%ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»ºå­è¿›ç¨‹ã€‚
    //å¿…é¡»é€šè¿‡autoWorkerå¼€å¯è‡ªåŠ¨è´Ÿè½½æ¨¡å¼æ‰æœ‰æ•ˆã€‚
    maxLoadRate: 75,

    //http2åè®®çš„http2Streamè¶…æ—¶ï¼Œè‹¥ä¸è®¾ç½®ï¼Œ-1è¡¨ç¤ºå’Œtimeoutä¸€è‡´ã€‚
    streamTimeout: -1,

    //è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œæ­¤è¶…æ—¶æ—¶é—´æ˜¯è¯·æ±‚æ€»çš„æ—¶é—´ï¼Œä¸»è¦æ˜¯ä¸ºäº†åº”å¯¹æ¶æ„è¯·æ±‚ã€‚
    //æ¯”å¦‚ï¼Œå‘å‡ºå¤§é‡è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚æ¯ç§’å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œç©ºé—²è¶…æ—¶ä¸ä¼šèµ·ä½œç”¨ï¼Œåˆ™å¯ä»¥é•¿æœŸå æœ‰æœåŠ¡å™¨èµ„æºã€‚
    //åœ¨å¤§é‡è¯·æ±‚æ—¶ï¼Œæ­£å¸¸ç”¨æˆ·æ— æ³•è®¿é—®ï¼Œæ­¤æ”»å‡»å±äºDDOSã€‚
    requestTimeout: 100000,

  };
  // å¯¹äºHTTPçŠ¶æ€ç ï¼Œåœ¨è¿™é‡Œä»…éœ€è¦è¿™ä¸¤ä¸ªï¼Œå…¶ä»–å¾ˆå¤šæ˜¯å¯ä»¥ä¸å¿…å®Œæ•´æ”¯æŒï¼Œå¹¶ä¸”ä½ å¯ä»¥åœ¨å®ç°åº”ç”¨æ—¶è‡ªè¡Œå¤„ç†ã€‚
  // å› ä¸ºä¸€æ—¦èƒ½å¤Ÿå¼€å§‹æ‰§è¡Œï¼Œå°±å¯ä»¥é€šè¿‡è¿è¡ŒçŠ¶æ€è¿”å›å¯¹åº”çš„çŠ¶æ€ç ã€‚
  // è€Œåœ¨è¿™ä¹‹å‰ï¼Œæ¡†æ¶è¿˜åœ¨ä¸ºå¼€å§‹æ‰§è¡Œæ´‹è‘±æ¨¡å‹åšå‡†å¤‡ï¼Œä¸è¿‡æ­¤è¿‡ç¨‹éå¸¸å¿«ã€‚

```

## è¯·æ±‚ä¸Šä¸‹æ–‡

è¯·æ±‚ä¸Šä¸‹æ–‡å°±æ˜¯ä¸€ä¸ªå°è£…äº†å„ç§è¯·æ±‚æ•°æ®çš„å¯¹è±¡ã€‚é€šè¿‡è¿™æ ·çš„è®¾è®¡ï¼ŒæŠŠHTTP/1.1 å’Œ HTTP/2åè®®çš„ä¸€äº›å·®å¼‚ä»¥åŠNode.jsç‰ˆæœ¬æ¼”è¿›å¸¦æ¥çš„ä¸€äº›ä¸å…¼å®¹åšäº†å¤„ç†ï¼Œå‡ºäºè®¾è®¡å’Œæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œå¯¹äºHTTP2æ¨¡å—ï¼Œå°è£…è¯·æ±‚å¯¹è±¡æ˜¯streamï¼Œè€Œä¸æ˜¯httpæ¨¡å—çš„IncomingMessageå’ŒServerResponseï¼ˆå°è£…å¯¹è±¡æ˜¯requestå’Œresponseï¼‰ã€‚

**è¯·æ±‚ä¸Šä¸‹æ–‡å±æ€§å’ŒåŸºæœ¬æè¿°**

| å±æ€§ | æè¿° |
| ---- | ---- |
| version | åè®®ç‰ˆæœ¬ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œä¸º'1.1' æˆ– '2'ã€‚ |
| major | åè®®ä¸»è¦ç‰ˆæœ¬å·ï¼Œ1ã€2ã€3åˆ†åˆ«è¡¨ç¤ºHTTP/1.1 HTTP/2 HTTP/3ï¼ˆç›®å‰è¿˜æ²¡æœ‰3ï¼‰ã€‚ |
| maxBody | æ”¯æŒçš„æœ€å¤§è¯·æ±‚ä½“å­—èŠ‚æ•°ï¼Œæ•°å­—ç±»å‹ï¼Œé»˜è®¤ä¸ºåˆå§‹åŒ–æ—¶ï¼Œä¼ é€’çš„é€‰é¡¹maxBodyçš„å€¼ï¼Œå¯ä»¥åœ¨ä¸­é—´ä»¶ä¸­æ ¹æ®è¯·æ±‚è‡ªåŠ¨è®¾å®šã€‚ |
| method | è¯·æ±‚ç±»å‹ï¼ŒGET POSTç­‰HTTPè¯·æ±‚ç±»å‹ï¼Œå¤§å†™å­—æ¯çš„å­—ç¬¦ä¸²ã€‚ |
| host | æœåŠ¡çš„ä¸»æœºåï¼Œå°±æ˜¯request.headers.hostçš„å€¼ã€‚ |
| protocol | åè®®å­—ç¬¦ä¸²ï¼Œä¸å¸¦å†’å·ï¼Œ'https'ã€'http'ã€‚ |
| path | å…·ä½“è¯·æ±‚çš„è·¯å¾„ã€‚ |
| routepath | å®é™…æ‰§è¡Œè¯·æ±‚çš„è·¯ç”±å­—ç¬¦ä¸²ã€‚ |
| query | urlä¼ é€’çš„å‚æ•°ã€‚ |
| param | è·¯ç”±å‚æ•°ã€‚ |
| files | ä¸Šä¼ æ–‡ä»¶ä¿å­˜çš„ä¿¡æ¯ã€‚ |
| body | bodyè¯·æ±‚ä½“çš„æ•°æ®ï¼Œå…·ä½“æ ¼å¼éœ€è¦çœ‹content-typeï¼Œä¸€èˆ¬ä¸ºå­—ç¬¦ä¸²æˆ–è€…å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯bufferã€‚ |
| port | å®¢æˆ·ç«¯è¯·æ±‚çš„ç«¯å£å·ã€‚ |
| ip | å®¢æˆ·ç«¯è¯·æ±‚çš„IPåœ°å€ï¼Œæ˜¯å¥—æ¥å­—çš„åœ°å€ï¼Œå¦‚æœä½¿ç”¨äº†ä»£ç†æœåŠ¡å™¨ï¼Œéœ€è¦æ£€æµ‹x-real-ipæˆ–æ˜¯x-forwarded-foræ¶ˆæ¯å¤´è·å–çœŸæ­£çš„IPã€‚ |
| headers | æŒ‡å‘request.headersã€‚ |
| isUpload() | æ˜¯å¦ä¸ºä¸Šä¼ æ–‡ä»¶è¯·æ±‚ï¼Œæ­¤æ—¶å°±æ˜¯æ£€æµ‹æ¶ˆæ¯å¤´content-typeæ˜¯å¦ä¸ºmultipart/form-dataæ ¼å¼ã€‚ |
| name | è·¯ç”±åç§°ï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚ |
| group | è·¯ç”±åˆ†ç»„ï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚ |
| res | HTTP/1.1åè®®ï¼ŒæŒ‡å‘responseï¼ŒHTTP/2 æŒ‡å‘streamã€‚ |
| req | HTTP/1.1 å°±æ˜¯httpæ¨¡å—requestäº‹ä»¶çš„å‚æ•°IncomingMessageå¯¹è±¡ï¼ŒHTTP/2 æŒ‡å‘streamå¯¹è±¡ã€‚ |
| box | é»˜è®¤ä¸ºç©ºå¯¹è±¡ï¼Œå¯ä»¥æ·»åŠ ä»»ä½•å±æ€§å€¼ï¼Œç”¨æ¥åŠ¨æ€ä¼ é€’ç»™ä¸‹ä¸€å±‚ç»„ä»¶éœ€è¦ä½¿ç”¨çš„ä¿¡æ¯ã€‚ |
| service | ç”¨äºä¾èµ–æ³¨å…¥çš„å¯¹è±¡ï¼ŒæŒ‡å‘app.serviceã€‚ |
| data | ä¿å­˜æœ€åè¦è¿”å›åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œç»™dataèµ‹å€¼å³å¯ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ctx.toå‡½æ•°ã€‚åœ¨v24.xç‰ˆæœ¬ä»¥å‰ï¼Œæ˜¯ctx\.res\.bodyã€‚ |
| ext | æä¾›äº†ä¸€äº›åŠ©æ‰‹å‡½æ•°ï¼Œå…·ä½“å‚è€ƒwikiã€‚ |
| to(data) | å‡½æ•°ï¼Œç”¨æ¥è®¾ç½®ctx.dataçš„æ•°æ®ã€‚ |
| write(data) | ç›´æ¥å†™å…¥æ•°æ®åˆ°å®¢æˆ·ç«¯ã€‚ |
| moveFile(file:object, target_filepath:string) | å‡½æ•°ï¼Œç”¨æ¥ç§»åŠ¨ä¸Šä¼ çš„æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„ã€‚ |
| status() | å‡½æ•°ï¼Œè®¾ç½®çŠ¶æ€ç ã€‚ |
| setHeader(k, v) | å‡½æ•°ï¼Œè®¾ç½®æ¶ˆæ¯å¤´ã€‚ |
| removeHeader(k) | å‡½æ•°ï¼Œç§»é™¤ç­‰å¾…å‘é€çš„æ¶ˆæ¯å¤´ã€‚ |
| getFile(name) | å‡½æ•°ï¼Œè·å–ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯ï¼Œå…¶å®å°±æ˜¯è¯»å–fileså±æ€§çš„ä¿¡æ¯ã€‚ |
| sendHeader() | å‡½æ•°ï¼Œç”¨äºhttp2å‘é€æ¶ˆæ¯å¤´ï¼ŒsetHeaderåªæ˜¯ç¼“å­˜äº†è®¾ç½®çš„æ¶ˆæ¯å¤´ã€‚å¯¹äºhttp/1.1æ¥è¯´ï¼Œä¸ºäº†ä¿æŒä»£ç ä¸€è‡´ï¼Œåªæ˜¯ä¸€ä¸ªç©ºå‡½æ•°ã€‚ |
| user | ç»™ç”¨æˆ·ç™»å½•æä¾›ä¸€ä¸ªæ ‡å‡†å±æ€§ï¼Œé»˜è®¤ä¹‹ä¸ºnullã€‚ |
| json(data) | å‡½æ•°ï¼Œè®¾ç½®è¿”å›æ•°æ®ï¼Œå¹¶æ ‡è®°ç±»å‹ä¸ºjsonã€‚ |
| text(data) | å‡½æ•°ï¼Œè®¾ç½®è¿”å›æ•°æ®ï¼Œå¹¶æ ‡è®°ç±»å‹ä¸ºtextã€‚ |
| html(data) | å‡½æ•°ï¼Œè®¾ç½®è¿”å›æ•°æ®ï¼Œå¹¶æ ‡è®°ç±»å‹ä¸ºhtmlã€‚ |
| pipe(filepath) | å‡½æ•°ï¼Œæµå¼å“åº”æ•°æ®ï¼Œç¤ºä¾‹ï¼šawait ctx.setHeader('content-type', 'text/html').pipe('./index.html') |
| pipeJson(filepath) | ä»¥jsonç±»å‹æµå¼å“åº”æ–‡ä»¶æ•°æ®ã€‚ |
| pipeText(filepath) | ä»¥textç±»å‹æµå¼å“åº”æ–‡ä»¶æ•°æ®ã€‚ |
| pipeHtml(filepath) | ä»¥htmlç±»å‹æµå¼å“åº”æ–‡ä»¶æ•°æ®ã€‚ |

æ³¨æ„ï¼štoå‡½æ•°åªæ˜¯è®¾ç½®ctx.dataå±æ€§çš„å€¼ï¼Œåœ¨æœ€åæ‰ä¼šè¿”å›æ•°æ®ã€‚å’Œç›´æ¥è¿›è¡Œctx.dataèµ‹å€¼æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯å› ä¸ºå‡½æ•°è°ƒç”¨å¦‚æœå‡ºé”™ä¼šæ›´å¿«å‘ç°é—®é¢˜ï¼Œè€Œè®¾ç½®å±æ€§å€¼å†™é”™äº†å°±æ˜¯æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å±æ€§ï¼Œä¸ä¼šæŠ¥é”™ä½†æ˜¯è¯·æ±‚ä¸ä¼šè¿”å›æ­£ç¡®çš„æ•°æ®ã€‚

## ä¾èµ–æ³¨å…¥

è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­æœ‰ä¸€é¡¹æ˜¯serviceï¼ŒæŒ‡å‘çš„æ˜¯app.serviceã€‚å½“åˆå§‹åŒ–appåï¼Œä¸€åˆ‡éœ€è¦å¼€å§‹å°±åˆå§‹åŒ–å¥½çš„æ•°æ®ã€å®ä¾‹ç­‰éƒ½å¯ä»¥æŒ‚è½½åˆ°app.serviceã€‚

``` JavaScript

'use strict';

const Topbit = require('topbit')

let app = new Topbit({
  debug: true
});

//æœ‰åˆ™ä¼šè¦†ç›–ï¼Œæ²¡æœ‰åˆ™æ·»åŠ ã€‚
app.addService('name', 'first')
app.addService('data', {
  id : 123,
  ip : '127.0.0.1'
})

/*
è¿™å¯èƒ½çœ‹ä¸å‡ºä»€ä¹ˆä½œç”¨ï¼Œæ¯•ç«Ÿåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç›´æ¥è®¿é—®å˜é‡éƒ½å¯ä»¥ï¼Œå¦‚æœè¦åšæ¨¡å—åˆ†ç¦»ï¼Œå°±å˜å¾—éå¸¸é‡è¦äº†ã€‚
*/
app.get('/info', async c => {
  c.to({
    name : c.service.name,
    data : c.service.data
  })
})

app.run(1234)

```

## æ‰©å±•è¯·æ±‚ä¸Šä¸‹æ–‡

å¦‚æœéœ€è¦ç»™è¯·æ±‚ä¸Šä¸‹æ–‡çš„å¯¹è±¡æ·»åŠ æ‰©å±•æ”¯æŒï¼Œå¯ä»¥é€šè¿‡appå®ä¾‹çš„httpServ.contextå®ç°ã€‚æ­¤å±æ€§æ˜¯è¯·æ±‚ä¸Šä¸‹æ–‡çš„æ„é€ å‡½æ•°ã€‚

**ç¤ºä¾‹ï¼š**

```javascript
'use strict'

const Topbit = require('topbit')

const app = new Topbit({
    debug: true
})

//thiså³è¡¨ç¤ºè¯·æ±‚ä¸Šä¸‹æ–‡
app.httpServ.context.prototype.testCtx = function () {
    console.log(this.method, this.path)
}

app.get('/test', async ctx => {
    ctx.testCtx()
})

app.run(1234)

```


## app.isMasterå’Œapp.isWorker

Node.jsåœ¨v16.xç‰ˆæœ¬å¼€å§‹ï¼Œclusteræ¨¡å—æ¨èä½¿ç”¨isPrimaryä»£æ›¿isMasterï¼Œä¸è¿‡isMasterä»ç„¶æ˜¯å¯ç”¨çš„ï¼Œåœ¨topbitåˆå§‹åŒ–appå®ä¾‹ä¹‹åï¼Œappä¸Šæœ‰ä¸¤ä¸ªgetterå±æ€§ï¼šisMasterå’ŒisWorkerã€‚ä½œç”¨å’Œclusterä¸Šçš„å±æ€§ä¸€è‡´ï¼Œå…¶ç›®çš„åœ¨äºï¼š

- åœ¨ä»£ç ä¸­ä¸å¿…å†æ¬¡ç¼–å†™const cluster = require('cluster')ã€‚

- å±è”½æœªæ¥clusterå¯èƒ½çš„ä¸å…¼å®¹æ›´æ”¹ï¼Œå¢å¼ºä»£ç å…¼å®¹æ€§ã€‚


## daemonå’Œrun

runæ¥å£çš„å‚æ•°ä¸ºï¼športã€hostã€‚hosté»˜è®¤ä¸º0.0.0.0ã€‚è¿˜å¯ä»¥æ˜¯sockPathï¼Œå°±æ˜¯.sockæ–‡ä»¶è·¯å¾„ï¼Œæœ¬è´¨ä¸Šæ˜¯å› ä¸ºhttpçš„listenæ¥å£æ”¯æŒã€‚ä½¿ç”¨.sockï¼Œhostå°±è¢«å¿½ç•¥äº†ã€‚

daemonçš„å‰ä¸¤ä¸ªå‚æ•°å’Œrunä¸€è‡´ï¼Œæ”¯æŒç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºè¦ä½¿ç”¨å¤šå°‘ä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚ã€‚é»˜è®¤ä¸º0ï¼Œè¿™æ—¶å€™ä¼šè‡ªåŠ¨æ ¹æ®CPUæ ¸å¿ƒæ•°é‡åˆ›å»ºå­è¿›ç¨‹ã€‚ä¹‹åï¼Œä¼šä¿æŒå­è¿›ç¨‹æ•°é‡çš„ç¨³å®šï¼Œåœ¨å­è¿›ç¨‹æ„å¤–ç»ˆæ­¢åä¼šåˆ›å»ºæ–°çš„å­è¿›ç¨‹è¡¥å……ã€‚

**clusteræ¨¡å¼ï¼Œæœ€å¤šå­è¿›ç¨‹æ•°é‡ä¸ä¼šè¶…è¿‡CPUæ ¸å¿ƒæ•°é‡çš„2å€ã€‚**

ç¤ºä¾‹ï¼š

```

//hosté»˜è®¤ä¸º0.0.0.0ï¼Œç«¯å£1234
app.run(1234)

//ç›‘å¬localhostï¼Œåªèƒ½æœ¬æœºè®¿é—®
app.run(1234, 'localhost')

//ä½¿ç”¨ä¸¤ä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚ï¼Œhosté»˜è®¤ä¸º0.0.0.0
app.daemon(1234, 2)

//ä½¿ç”¨3ä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚
app.daemon(1234, 'localhost', 3)

```

## æ—¥å¿—

æ¡†æ¶æœ¬èº«æä¾›äº†å…¨å±€æ—¥å¿—åŠŸèƒ½ï¼Œå½“ä½¿ç”¨clusteræ¨¡å¼æ—¶ï¼ˆä½¿ç”¨daemonæ¥å£è¿è¡ŒæœåŠ¡ï¼‰ï¼Œä½¿ç”¨åˆå§‹åŒ–é€‰é¡¹globoalLogå¯ä»¥å¼€å¯å…¨å±€æ—¥å¿—ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šæ—¥å¿—æ–‡ä»¶ï¼Œåœ¨å•è¿›ç¨‹æ¨¡å¼ï¼Œä¼šæŠŠæ—¥å¿—è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œæ­¤æ—¶åˆ©ç”¨è¾“å‡ºé‡å®šå‘å’Œé”™è¯¯è¾“å‡ºé‡å®šå‘ä»ç„¶å¯ä»¥æŠŠæ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶ã€‚

**æ³¨æ„ï¼šåªæœ‰ä½¿ç”¨daemonè¿è¡Œï¼Œé‡‡ç”¨clusteræ¨¡å¼ï¼Œæ‰å¯ä»¥æŠŠæ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶ï¼Œrunè¿è¡Œåçš„å•è¿›ç¨‹ä»…ä»…æ˜¯è¾“å‡ºåˆ°å±å¹•ï¼Œå¯ä»¥åˆ©ç”¨IOé‡å®šå‘ä¿å­˜åˆ°æ–‡ä»¶ã€‚**

é™¤äº†ä¿å­˜åˆ°æ–‡ä»¶å’Œè¾“å‡ºåˆ°ç»ˆç«¯è¿›è¡Œè°ƒè¯•ï¼Œè¿˜å¯ä»¥åˆ©ç”¨logHandleé€‰é¡¹è®¾ç½®è‡ªå·±çš„æ—¥å¿—å¤„ç†å‡½æ•°ã€‚

**è®¾ç½®äº†logHandleï¼ŒlogFileå’ŒerrorLogFileä¼šå¤±æ•ˆï¼Œå…·ä½“è¯·çœ‹ä»£ç ã€‚**

ç¤ºä¾‹ï¼š

``` JavaScript

const Topbit = require('topbit')

const app = new Topbit({
  debug: true,
  //å…¨å±€æ—¥å¿—å¼€å¯
  globalLog: true,

  //è¡¨ç¤ºè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºstdioè¡¨ç¤ºè¾“å‡ºåˆ°ç»ˆç«¯ã€‚
  logType: 'file'

  //è¿”å›çŠ¶æ€ç ä¸º2xxæˆ–è€…3xx
  logFile : '/tmp/topbit.log',

  //é”™è¯¯çš„æ—¥å¿—è¾“å‡ºæ–‡ä»¶ï¼Œè¿”å›çŠ¶æ€ç 4xxæˆ–è€…5xx
  errorLogFile: '/tmp/topbit-error.log',

  //è‡ªå®šä¹‰å¤„ç†å‡½æ•°ï¼Œæ­¤æ—¶logFileå’ŒerrorLogFileä¼šå¤±æ•ˆã€‚
  //æ¥æ”¶å‚æ•°ä¸º(worker, message)
  //workerå…·ä½“å‚è€ƒclusterçš„workeræ–‡æ¡£
  /*
    msgä¸ºæ—¥å¿—å¯¹è±¡ï¼Œå±æ€§ï¼š
      {
        type : '_log',
        success : true,
        log : '@ GET | https://localhost:2021/randst | 200 | 2020-10-31 20:27:7 | 127.0.0.1 | User-Agent'
      }
  */
  logHandle : (w, msg) => {
    console.log(w.id, msg)
  }

})

app.daemon(1234, 3)

```

ä½¿ç”¨ä¸­é—´ä»¶çš„æ–¹å¼å¤„ç†æ—¥å¿—å’Œå…¨å±€æ—¥å¿—å¹¶ä¸å†²çªï¼Œè€Œå¦‚æœè¦é€šè¿‡ä¸­é—´ä»¶è¿›è¡Œæ—¥å¿—å¤„ç†ä¼šæ— æ³•æ•è·æ²¡æœ‰è·¯ç”±è¿”å›404çš„æƒ…å†µï¼Œå› ä¸ºæ¡†æ¶ä¼šå…ˆæŸ¥æ‰¾è·¯ç”±ï¼Œæ²¡æœ‰åˆ™ä¼šè¿”å›ã€‚è¿™æ—¶å€™ï¼Œä¸ä¼šæœ‰è¯·æ±‚ä¸Šä¸‹æ–‡çš„åˆ›å»ºï¼Œç›´æ¥è¿”å›è¯·æ±‚ï¼Œé¿å…æ— æ„ä¹‰çš„æ“ä½œã€‚

è€Œä¸”ï¼Œè¿™æ ·çš„æ–¹å¼å…¶å®æ›´åŠ å®¹æ˜“å’Œclusteræ¨¡å¼ç»“åˆï¼Œå› ä¸ºåœ¨å†…éƒ¨å°±æ˜¯åˆ©ç”¨masterå’Œworkerçš„é€šä¿¡æœºåˆ¶å®ç°çš„ã€‚

## æ¶ˆæ¯äº‹ä»¶å¤„ç†

åŸºäºmessageäº‹ä»¶ï¼Œåœ¨daemonæ¨¡å¼ï¼ˆåŸºäºclusteræ¨¡å—ï¼‰ï¼Œæä¾›äº†ä¸€ä¸ªsetMsgEventå‡½æ•°ç”¨äºè·å–å­è¿›ç¨‹å‘é€çš„äº‹ä»¶æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚

è¿™è¦æ±‚workerè¿›ç¨‹å‘é€çš„æ¶ˆæ¯å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­çš„typeå±æ€§æ˜¯å¿…éœ€çš„ï¼Œè¡¨ç¤ºæ¶ˆæ¯äº‹ä»¶çš„åç§°ã€‚å…¶ä»–å­—æ®µçš„æ•°æ®çš†å¯ä»¥è‡ªå®šä¹‰ã€‚

ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

``` JavaScript

const Topbit = require('topbit')
const cluster = require('cluster')

const app = new Topbit({
  debug: true,
  loadInfoFile: '/tmp/loadinfo.log'
})

if (cluster.isMaster) {
  app.setMsgEvent('test-msg', (worker, msg, handle) => {
    //å­è¿›ç¨‹ä¸­ä¼šé€šè¿‡messageäº‹ä»¶æ”¶åˆ°æ¶ˆæ¯
    worker.send({
      id : worker.id,
      data : 'ok'
    })

    console.log(msg)
  })
} else {
  //æ¥æ”¶worker.toå‘é€çš„æ¶ˆæ¯
  process.on('message', msg => {
    console.log(msg)
  })

  setIneterval(() => {
    process.send({
      type : 'test-msg',
      pid : process.pid,
      time : (new Date()).toLocaleString()
    })
  }, 1000)

}

```

æ¯”è¾ƒéº»çƒ¦çš„åœ°æ–¹åœ¨äºï¼Œworkerè¿›ç¨‹å‘é€æ¶ˆæ¯æ¯”è¾ƒå¤æ‚ï¼Œåœ¨22.4.0ç‰ˆæœ¬å¼€å§‹ï¼Œæä¾›äº†ä¸€ä¸ªsendæ–¹æ³•ç”¨äºå¿«é€Ÿå‘é€æ¶ˆæ¯ã€‚åªæœ‰åœ¨workerè¿›ç¨‹ä¸­æ‰ä¼šå‘é€ç»™masterè¿›ç¨‹ï¼Œæ‰€ä»¥ä¸å¿…é¢å¤–è¿›è¡Œworkerè¿›ç¨‹æ£€æµ‹ã€‚

## app.send å’Œ app.workerMsg

ç°åœ¨è®©æˆ‘ä»¬æ¥æ”¹å†™ä¸Šé¢ä»£ç çš„workerè¿›ç¨‹å‘é€æ¶ˆæ¯çš„éƒ¨åˆ†ï¼š

```javascript

const Topbit = require('topbit')

const app = new Topbit({
  debug: true,
  loadInfoFile: '/tmp/loadinfo.log'
})

//masterè¿›ç¨‹æ³¨å†Œæ¶ˆæ¯äº‹ä»¶ç±»å‹ï¼Œworkerè¿›ç¨‹ä¸ä¼šæ‰§è¡Œã€‚
app.setMsgEvent('test-msg', (worker, msg, handle) => {
  //å­è¿›ç¨‹ä¸­ä¼šé€šè¿‡messageäº‹ä»¶æ”¶åˆ°æ¶ˆæ¯
  worker.send({
    id : worker.id,
    data : 'ok'
  })

  console.log(msg)
})

//åªæœ‰workerè¿›ç¨‹æ‰ä¼šç›‘å¬ã€‚
app.workerMsg(msg => {
  console.log(msg)
})

cluster.isWorker
    &&
setInterval(() => {
  //åªæœ‰workerä¼šæ‰§è¡Œã€‚
  app.send('test-msg', {
    pid: process.pid,
    time: (new Date).toLocaleString()
  })

}, 1000)

app.daemon(1234, 2)

```

## è‡ªåŠ¨è°ƒæ•´å­è¿›ç¨‹æ•°é‡

é€šè¿‡daemonä¼ é€’çš„å‚æ•°ä½œä¸ºåŸºæœ¬çš„å­è¿›ç¨‹æ•°é‡ï¼Œæ¯”å¦‚ï¼š

``` JavaScript

//ä½¿ç”¨2ä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚ã€‚
app.daemon(1234, 2)

```

å¦‚æœéœ€è¦è‡ªåŠ¨æ ¹æ®è´Ÿè½½åˆ›å»ºå­è¿›ç¨‹ï¼Œå¹¶åœ¨è´Ÿè½½ç©ºé—²æ—¶ç»ˆæ­¢è¿›ç¨‹ï¼Œç»´æŒåŸºæœ¬çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨autoWorkeræ¥å£æ¥è®¾ç½®ä¸€ä¸ªæœ€å¤§å€¼ï¼Œè¡¨ç¤ºæœ€å¤§å…è®¸å¤šå°‘ä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚ï¼Œè¿™ä¸ªå€¼å¿…é¡»è¦æ¯”åŸºæœ¬çš„å­è¿›ç¨‹æ•°é‡å¤§æ‰ä¼šç”Ÿæ•ˆã€‚

```

//æœ€å¤§ä½¿ç”¨9ä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚ã€‚
app.autoWorker(9)

//...

app.daemon(1234, 2)

```

å½“è´Ÿè½½è¿‡é«˜æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºå­è¿›ç¨‹ï¼Œå¹¶ä¸”åœ¨ç©ºé—²ä¸€æ®µæ—¶é—´åï¼Œä¼šè‡ªåŠ¨ç»ˆæ­¢è¿æ¥æ•°é‡ä¸º0çš„å­è¿›ç¨‹ï¼Œæ¢å¤åˆ°åŸºæœ¬çš„æ•°å€¼ã€‚

**æ­¤åŠŸèƒ½åœ¨v21.9.6+ç‰ˆæœ¬å¯ç”¨ã€‚ä½†æ˜¯è¯·å°½å¯èƒ½ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼Œæ­¤åŠŸèƒ½åœ¨åç»­ç‰ˆæœ¬ç»å†å‡ æ¬¡å‡çº§æ”¹è¿›ï¼Œæé«˜äº†ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œä¿è¯åœ¨ä¸¥è‹›çš„ä¸šåŠ¡é€»è¾‘ä¸Šä»ç„¶èƒ½å¤Ÿæä¾›ç¨³å®šçš„æœåŠ¡æ”¯æŒã€‚**

----

## ğŸ›¡ï¸strongæ¨¡å¼

é€šè¿‡strongé€‰é¡¹å¯ä»¥å¼€å¯strongæ¨¡å¼ï¼Œæ­¤æ¨¡å¼ä¼šç›‘å¬uncaughtExceptionå’ŒunhandledRejectionäº‹ä»¶ï¼Œä¿è¯ç¨‹åºç¨³å®šè¿è¡Œã€‚æœ€ç®€å•çš„æƒ…å†µï¼Œä½ åªéœ€è¦ç»™strongè®¾ç½®ä¸ºtrueå³å¯ã€‚

**strongæ¨¡å¼çš„æ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥é€šè¿‡processæ¨¡å—è‡ªè¡Œå®ç°ï¼Œæ­¤å¤„åªæ˜¯ç®€åŒ–äº†å¤„ç†æ–¹å¼è€Œå·²ã€‚**

```javascript
'use strict';

const Topbit = require('topbit');

setTimeout(() => {
  //åœ¨å®šæ—¶å™¨çš„å¾ªç¯é‡ŒæŠ›å‡ºå¼‚å¸¸
  throw new Error(`test error`)
}, 2000);

const app = new Topbit({
    //è°ƒè¯•æ¨¡å¼ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚
    debug: true,
    //å¼€å¯strongæ¨¡å¼
    strong: true
});

app.run(1234);

```

é»˜è®¤æƒ…å†µä¸‹ï¼Œstrongæ¨¡å¼ä¼šæ•è·ä»¥ä¸‹é”™è¯¯ï¼š

```
'TypeError', 'ReferenceError', 'RangeError', 'AssertionError', 'URIError', 'Error'
```

ä½†æ˜¯ï¼Œä½ å¯èƒ½éœ€è¦è‡ªå®šä¹‰å¤„ç†æ–¹å¼ï¼Œè¿™å¯ä»¥é€šè¿‡ç»™strongä¼ é€’objectç±»å‹çš„é€‰é¡¹æ¥å®ç°ã€‚

```javascript

//æ ¸å¿ƒä»£ç ç¤ºä¾‹
const app = new Topbit({
    //è°ƒè¯•æ¨¡å¼ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚
    debug: true,
    //å¼€å¯strongæ¨¡å¼
    strong: {
      //é™é»˜è¡Œä¸ºï¼Œä¸ä¼šè¾“å‡ºé”™è¯¯ã€‚
      quiet: true,
      //è‡ªå®šä¹‰é”™è¯¯å¤„ç†å‡½æ•°
      errorHandle: (err, errname) => {
        //....
      },

      //è¦æ•è·çš„é”™è¯¯æœ‰å“ªäº›
      catchErrors: [
        'TypeError', 'URIError', 'Error', 'RangeError'
      ]

    }
});

```

## ğŸ””åŒæ—¶è¿è¡Œhttpå’Œhttpsï¼Ÿ

è¯·æ³¨æ„è¿™æ˜¯æ‰“é—®å·çš„ï¼Œä½ æœ€å¥½ä¸è¦åœ¨æ­£å¼ç¯å¢ƒè¿™æ ·åšï¼Œå¦‚æœä½ å·²ç»å¼€å¯äº†httpsï¼Œåˆ™ä¸éœ€è¦httpï¼Œè€Œä¸”å‰ç«¯åº”ç”¨æœ‰äº›åŠŸèƒ½åœ¨ä¸å¯ç”¨httpsæ˜¯æ— æ³•ä½¿ç”¨çš„ã€‚

å¦‚æœä½ éœ€è¦è¿™æ ·åŠŸèƒ½ï¼Œä¹Ÿè®¸æ˜¯ç”¨äºæµ‹è¯•ï¼Œé‚£ä¹ˆä½ å¯ä»¥è¿™æ ·åšï¼š

```javascript
'use strict'

const Topbit = require('topbit')
const http = require('node:http')
const https = require('https')

const app = new Topbit({
    //å¯ç”¨è°ƒè¯•
    debug: true,
})

//ä»¥ä¸‹éƒ½æ˜¯http/1.1çš„æœåŠ¡ï¼Œè‹¥è¦åŒæ—¶æ”¯æŒhttp2ï¼Œéœ€è¦å¯ç”¨http2æœåŠ¡å¹¶å…¼å®¹http1ï¼Œè‹¥æœ‰éœ€è¦è¯·ä½¿ç”¨topbit-httpcæ‰©å±•ã€‚

//è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦è‡ªå·±è®¾å®šç›¸å…³äº‹ä»¶çš„ç›‘å¬å¤„ç†ã€‚

let http_server = http.createServer(app.httpServ.onRequest())
let https_server = https.createServer(app.httpServ.onRequest())

http_server.listen(2025)
https_server.listen(2026)

```

**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æƒ…å†µæ— æ³•å†å»æ”¯æŒhttp2ï¼Œä½†æ˜¯ä½ å¯ä»¥ä½¿ç”¨http2å»å…¼å®¹http1ã€‚**

## è¯·æ±‚é™æµ

æ¡†æ¶å±‚é¢æä¾›çš„é™æµæ˜¯åŸºäºIPåœ°å€çš„è®¡ç®—å’Œè¿‡æ»¤ï¼Œé¿å…åŒä¸€ä¸ªIPåœ°å€å¯†é›†çš„å‘é€è¯·æ±‚ã€‚è‹¥ä½¿ç”¨HTTP/2åè®®ï¼Œåˆ™éœ€è¦é…åˆä½¿ç”¨topbit-toolkitæ‰©å±•çš„http2limitæ¨¡å—ã€‚

```javascript
'use strict';

const Topbit = require('topbit')

const app = new Topbit({
    debug : true,
    //å¯ç”¨è¯·æ±‚é™åˆ¶
    useLimit: true,

    //å…è®¸è®¿é—®ï¼Œä¸åšå•ä½æ—¶é—´è¯·æ±‚é¢‘ç‡é™åˆ¶çš„IPåœ°å€
    allow: new Set(['127.0.0.1']),

    //æ‹’ç»è¿æ¥çš„IPåœ°å€
    deny: (ip) => {
      //åªæ˜¯ç¤ºä¾‹ï¼Œæ”¯æŒå‡½æ•°å’ŒSetç±»å‹
      if (ip.indexOf('1.') === 0) return false
      return true
    },
    
    //æ¯ä¸ªIPåœ°å€å•ä½æ—¶é—´å†…å…è®¸è¯·æ±‚çš„æ¬¡æ•°
    maxIPRequest: 6,
    
    //å•ä½æ—¶é—´ï¼Œè¡¨ç¤º15ç§’
    unitTime: 15,
    
    //ä¸€ä¸ªworkerè¿›ç¨‹å…è®¸çš„æœ€å¤§å¹¶å‘è¿æ¥
    maxConn: 2000,

    loadMonitor: true,
    loadInfoType : 'text',
    globalLog : true,
    logType: 'stdio',
    //è´Ÿè½½ä¿¡æ¯æ”¾åœ¨å†…å­˜ä¸­
    loadInfoFile : '--mem'
})


app.get('/', async ctx => {
  ctx.to('ok')
})

//ä½¿ç”¨3ä¸ªworkerè¿›ç¨‹å¤„ç†è¯·æ±‚ï¼Œæ¯ä¸ªéƒ½æ”¯æŒå•ä½æ—¶é—´å†…è¯·æ±‚6æ¬¡
//è‹¥æƒ³è¦å¤§æ¦‚æ€»å…±å¤„ç†6æ¬¡ï¼Œåˆ™è®¾ç½®maxIPRequestä¸º2
app.daemon(1234, '0.0.0.0', 3)

```

## å…¶ä»–

- topbitåœ¨è¿è¡Œåï¼Œä¼šæœ‰ä¸€ä¸ªæœ€ååŒ…è£…çš„ä¸­é—´ä»¶åšæœ€ç»ˆçš„å¤„ç†ï¼Œæ‰€ä»¥è®¾ç½®c.dataçš„å€¼å°±ä¼šè¿”å›æ•°æ®ï¼Œé»˜è®¤ä¼šæ£€æµ‹ä¸€äº›ç®€å•çš„æ–‡æœ¬ç±»å‹å¹¶è‡ªåŠ¨è®¾å®šcontent-typeï¼ˆtext/plain,text/html,application/jsonï¼‰ã€‚æ³¨æ„è¿™æ˜¯åœ¨ä½ æ²¡æœ‰è®¾ç½®content-typeçš„æƒ…å†µä¸‹è¿›è¡Œã€‚

- é»˜è®¤ä¼šé™åˆ¶urlçš„æœ€å¤§é•¿åº¦ï¼Œä¹Ÿä¼šæ ¹æ®ç¡¬ä»¶æƒ…å†µè®¾å®šä¸€ä¸ªæœ€å¤§å†…å­˜ä½¿ç”¨ç‡ã€‚

- è¿™ä¸€åˆ‡ä½ éƒ½å¯ä»¥é€šè¿‡é…ç½®é€‰é¡¹æˆ–æ˜¯ä¸­é—´ä»¶æ¥è¿›è¡Œæ‰©å±•å’Œé‡å†™ï¼Œæ—¢æœ‰é™åˆ¶ä¹Ÿæœ‰è‡ªç”±ã€‚

- å®ƒå¾ˆå¿«ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸€ç›´åœ¨éƒ½åœ¨å…³æ³¨ä¼˜åŒ–ã€‚

- æä¾›äº†ä¸€ä¸ªschedå‡½æ•°ç”¨æ¥å¿«é€Ÿè®¾ç½®clusteræ¨¡å¼çš„è°ƒåº¦æ–¹å¼ï¼Œæ”¯æŒå‚æ•°ä¸º'rr'æˆ–'none'ï¼Œæœ¬è´¨å°±æ˜¯è®¾ç½®cluster.schedulingPolicyçš„å€¼ã€‚


æ¡†æ¶åœ¨åˆå§‹åŒ–ä¼šè‡ªåŠ¨æ£€æµ‹å†…å­˜å¤§å°å¹¶è®¾å®šç›¸å…³ä¸Šé™ï¼Œä½ å¯ä»¥åœ¨åˆå§‹åŒ–åï¼Œé€šè¿‡æ›´æ”¹secureä¸­çš„å±æ€§æ¥æ›´æ”¹é™åˆ¶ï¼Œè¿™éœ€è¦ä½ ä½¿ç”¨daemonæ¥å£ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨masterç®¡ç†å­è¿›ç¨‹çš„æ¨¡å¼ã€‚


```javascript
'use strict'

const Topbit = require('topbit')

let app = new Topbit()

/*
 ä»¥ä¸‹æ“ä½œå¯ä»¥é€šè¿‡é€‰é¡¹memFactoræ§åˆ¶ï¼Œè¯·å‚è€ƒä¸Šæ–‡çš„é…ç½®é€‰é¡¹éƒ¨åˆ†ã€‚
 */

//æœ€å¤§å†…å­˜è®¾å®šä¸º600Mï¼Œä½†æ˜¯åªæœ‰åœ¨è¿æ¥æ•°ä¸º0æ—¶æ‰ä¼šè‡ªåŠ¨é‡å¯ã€‚
app.secure.maxmem = 600_000_000;

//å¿…é¡»è¦é‡å¯çš„æœ€å¤§å†…å­˜ä¸Šé™è®¾å®šä¸º900Mï¼Œæ³¨æ„è¿™æ˜¯æ€»çš„å†…å­˜ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä½ ç”¨Bufferç”³è¯·çš„å†…å­˜ã€‚
//è¿™ä¸ªå€¼ä¸€èˆ¬è¦æ¯”maxmemå¤§ï¼Œå½“å†…å­˜ä½¿ç”¨è¶…è¿‡maxmemè®¾ç½®çš„å€¼ï¼Œ
//ä½†æ˜¯è¿æ¥ä¸ä¸º0ï¼Œè¿™æ—¶å€™å¦‚æœç»§ç»­è¯·æ±‚è¶…è¿‡diememè®¾ç½®çš„å€¼ï¼Œåˆ™ä¼šç›´æ¥é‡å¯è¿›ç¨‹ã€‚
app.secure.diemem = 900_000_000;

//æœ€å¤§å†…å­˜ä½¿ç”¨è®¾ç½®ä¸º800Mï¼Œè¿™ä¸ªå°±æ˜¯ç¨‹åºè¿è¡Œä½¿ç”¨çš„å†…å­˜ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬Bufferç”³è¯·çš„å†…å­˜ã€‚
app.secure.maxrss = 800_000_000;

app.get('/', async c => {
  c.to('ok')
})

app.daemon(8008, 2)

```

**æ³¨æ„ï¼Œè¿™éœ€è¦ä½ å¼€å¯loadMonitoré€‰é¡¹ï¼Œè¿™æ˜¯é»˜è®¤å¼€å¯çš„ã€‚**

---

# ğŸ§© ä¸­é—´ä»¶æ‰©å±•å’Œå…¶ä»–æ‰©å±• ğŸ“œ

---

ä½œä¸ºWebæ¡†æ¶ï¼Œä»…ä»…æä¾›åŸºç¡€åŠŸèƒ½æ˜¯ä¸å¤Ÿçš„ï¼Œå¾ˆå¤šåŸºç¡€åŠŸèƒ½åœ¨æ‰€æœ‰WebæœåŠ¡ä¸Šéƒ½ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå‡ºç°é€šç”¨çš„æ‰©å±•æ¨¡å—ã€‚

åœ¨Topbitå…¨å±€ä¸­é—´ä»¶è®¾è®¡æœºåˆ¶ä¸Šï¼Œå¤§éƒ¨åˆ†å’ŒWebæœåŠ¡æœ‰å…³çš„æ‰©å±•éƒ½å¯ä»¥é€šè¿‡å¼€å‘ä¸€ä¸ªä¸­é—´ä»¶æ‰©å±•å®Œæˆï¼Œå¯ä»¥å‚è€ƒ `ä¸­é—´ä»¶` éƒ¨åˆ†ï¼Œè¿™ç§æ’ä»¶æœºåˆ¶ååˆ†çµæ´»ã€‚

**Topbitæä¾›äº†ä¸€äº›é€šç”¨ä¸­é—´ä»¶æ‰©å±•ï¼Œå¼€å‘è€…å¯ä»¥æŒ‰éœ€ä½¿ç”¨ã€‚**

**ä¹Ÿæä¾›äº†ä¸€äº›å…¶ä»–æ‰©å±•æ¨¡å—ï¼šè·¯ç”±åŠ è½½å™¨ã€Tokenä¼šè¯éªŒè¯ã€å‘½ä»¤å‚æ•°è§£æã€é”™è¯¯æ—¥å¿—è‡ªåŠ¨åŒ–å¤„ç†ã€zipå‹ç¼©å’Œè§£å‹ã€‚**

## å¯¼å…¥ä¸­é—´ä»¶æ‰©å±•

æ‰€æœ‰ä¸­é—´ä»¶æ‰©å±•éƒ½åœ¨Topbit.extensionsä¸‹ï¼Œç¤ºä¾‹ï¼š

```javascript
'use strict'

process.chdir(__dirname)

const Topbit = require('Topbit')

//é€šè¿‡è§£æ„èµ‹å€¼å¯¼å…¥æ‰©å±•
const {Cors, ToFile} = Topbit.extensions

const app = new Topbit({
  debug: true,
  //å¼€å¯æ—¥å¿—ï¼Œæ˜¯globalLogçš„åˆ«å
  log: true
})

// è·¨åŸŸæ‰©å±•åœ¨è§£æbodyä¹‹å‰è¿è¡Œ
// useæ·»åŠ çš„ä¸­é—´ä»¶è§£æbodyæ•°æ®ä¹‹åè¿è¡Œ
app.pre(new Cors())
  .use(new ToFile, {method: ['PUT', 'POST']})

app.post('/file', async ctx => {
  let f = ctx.getFile('file')
  if (!f) return ctx.status(400).to('file not found')

  ctx.to(
    await f.toFile('./uploads')
  )
})

app.run(1235)
```

## â˜² ä¸­é—´ä»¶æ‰©å±•


| ä¸­é—´ä»¶      | æè¿°                                                                 |
|----------------|----------------------------------------------------------------------|
| Cors           | æ”¯æŒè·¨åŸŸè¯·æ±‚çš„ä¸­é—´ä»¶ã€‚                                                |
| Resource       | é™æ€èµ„æºå¤„ç†ï¼Œæ˜¯ç›®å‰æœ€å¼ºé™æ€èµ„æºå¤„ç†æœåŠ¡ã€‚                              |
| ToFile         | è®©ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡å…·å¤‡ `toFile` æ–¹æ³•ã€‚                                   |
| SSE            | SSEåè®®ä¸­é—´ä»¶ï¼ŒåŸºäºHTTPçš„æ•°æ®æµæ¨é€ã€‚                                 |
| Proxy          | é’ˆå¯¹ HTTP/1.1 åè®®çš„åå‘ä»£ç†ï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡å’Œ alive æ£€æµ‹ã€‚               |
| Http2Proxy     | HTTP/2 åè®®çš„åå‘ä»£ç†ï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡å’Œ alive æ£€æµ‹ã€‚                     |
| SNI            | HTTPS å¤šåŸŸåæ”¯æŒã€‚                                                    |
| ParamCheck     | è¯·æ±‚å‚æ•°æ£€æµ‹ï¼Œæ”¯æŒ `param`ã€`query`ã€`body` çš„æ£€æµ‹ã€‚                   |
| JWT            | JWT åè®®çš„ token éªŒè¯ï¼Œæ¨èä½¿ç”¨ Topbit.Tokenï¼Œæ¯” JWT å¼ºå¤ªå¤šã€‚          |
| Cookie         | è§£æå‰ç«¯è¯·æ±‚çš„æ¶ˆæ¯å¤´ cookieã€‚                                         |
| Session        | Session ä¼šè¯ï¼Œä½¿ç”¨çš„æ˜¯æœ¬åœ°æ–‡ä»¶æœºåˆ¶ã€‚                                   |

---

ä»¥ä¸‹æ˜¯æ ¹æ®ä½ æä¾›çš„ `titbit-toolkit` åŸå§‹æ–‡æ¡£å†…å®¹ï¼ŒæŒ‰ç…§æ–°çš„åˆ—è¡¨é¡ºåºé‡æ–°æ•´ç†çš„æ–‡æ¡£ã€‚

**æ³¨æ„**ï¼š
*   æ ¹æ®æŒ‡ç¤ºï¼Œæ–‡æ¡£å·²é’ˆå¯¹æ–°çš„ **Topbit** æ¡†æ¶è¯­å¢ƒè¿›è¡Œäº†è°ƒæ•´ï¼ˆå³ä¸å†å¼ºè°ƒç‹¬ç«‹å®‰è£…æ‰©å±•ï¼‰ã€‚
*   åˆ—è¡¨ä¸­æœªåŒ…å«çš„ç»„ä»¶ï¼ˆå¦‚ `Timing`, `RealIP`, `MixLogger`, `SendType`, `SetFinal`, `Http2Limit`ï¼‰å·²è¢«ç§»é™¤ã€‚
*   åˆ—è¡¨ä¸­åŒ…å«ä½†åŸæ–‡æ¡£æœªæä¾›è¯¦ç»†è¯´æ˜çš„ç»„ä»¶ï¼ˆå¦‚ `SNI`ï¼‰ï¼Œä»…ä¿ç•™äº†æè¿°å ä½ç¬¦ã€‚

---

### 1. Cors (è·¨åŸŸæ”¯æŒ)

æ”¯æŒè·¨åŸŸè¯·æ±‚çš„ä¸­é—´ä»¶ã€‚å°½ç®¡æ˜¯å¯¹è·¨åŸŸåœºæ™¯çš„æ”¯æŒï¼Œä½†åœ¨å…·å¤‡ `origin` æ¶ˆæ¯å¤´çš„è·¨åŸŸé€šä¿¡å’Œ `referer` èµ„æºå¼•å…¥åœºæ™¯éƒ½åšäº†æ”¯æŒï¼Œå¹¶ä¸”å¯ä»¥çµæ´»é€‰æ‹©å’Œé…ç½®ã€‚

**åŸºæœ¬ä½¿ç”¨ï¼š**

```javascript
const Topbit = require('topbit')
const {Cors} = Topbit.extensions

let cr = new Cors({
    // é»˜è®¤ä¸º * è¡¨ç¤ºå…¨éƒ¨å¼€å¯è·¨åŸŸï¼Œ
    // è‹¥è¦æŒ‡å®šè¦æ”¯æŒçš„åŸŸååˆ™éœ€è¦ä¼ é€’ä¸€ä¸ªæ•°ç»„ã€‚
    // æ³¨æ„ï¼šè¿™é‡ŒæŒ‡å®šçš„æ˜¯ç”¨äºè®¿é—®æ¥å£çš„åº”ç”¨é¡µé¢æ‰€åœ¨åŸŸã€‚
    allow : [
        'https://a.com',
        'https://www.a.com',
    ],

    // é»˜è®¤åªæœ‰ content-type
    allowHeaders : 'authorization,content-type',

    // OPTIONS è¯·æ±‚ç¼“å­˜ 60 ç§’ï¼Œæ­¤æœŸé—´æµè§ˆå™¨è¯·æ±‚ä¼šå…ˆå»è¯»å–ç¼“å­˜ã€‚
    optionsCache: 60,

    // é»˜è®¤ä¸º '*'ï¼Œå¯ä»¥è®¾ç½®å…è®¸çš„è¯·æ±‚æ–¹æ³•ã€‚
    // requestHeaders : '*'

    // é»˜è®¤ä¸º ''ï¼Œè¡¨ç¤ºå“ªäº›æ¶ˆæ¯å¤´å¯ä»¥æš´éœ²ç»™è¯·æ±‚ç«¯ï¼Œå¤šä¸ªæ¶ˆæ¯å¤´ä½¿ç”¨ , åˆ†éš”ã€‚
    // exposeHeaders: 'x-test-key,x-type'
})

app.pre(cr)

// æ”¯æŒ OPTIONS è¯·æ±‚ï¼Œæµè§ˆå™¨åœ¨å¤„ç† POST/PUT/DELETE æ—¶ä¼šå…ˆå‘é€ OPTIONS é¢„æ£€è¯·æ±‚ã€‚
// å¿…é¡»å¤„ç† OPTIONS è¯·æ±‚æ‰èƒ½å®Œæ•´æ”¯æŒè·¨åŸŸã€‚
app.options('/*', async c => {})
```

**é«˜çº§é…ç½®ï¼ˆRefereræ£€æµ‹ä¸åˆ†ç»„ï¼‰ï¼š**

```javascript
let cr = new cors({
  // ä¸å…è®¸ referer ä¸ºç©º
  allowEmptyReferer: false,

  // å…è®¸ referer ä¸ºç©ºçš„è·¯ç”±åˆ†ç»„ï¼Œ
  // åˆ†ç»„åç§°æ˜¯è‡ªå®šä¹‰çš„ï¼Œå‚è€ƒæ¡†æ¶çš„è·¯ç”±åˆ†ç»„åŠŸèƒ½ã€‚
  // æ­¤åŠŸèƒ½ä¸»è¦ç”¨äºåœ¨ API å¼€å‘ä¸­è¿˜è¦å…¼é¡¾é¡µé¢çš„æœåŠ¡ä¸Šã€‚
  emptyRefererGroup: [
    '@webapp', '@pages'
  ],

  allow: [
     // é»˜è®¤çš„å­—ç¬¦ä¸²å½¢å¼è¡¨ç¤º origin è·¨åŸŸå’Œ referer å¤–é“¾æ¥å¼•ç”¨éƒ½è¢«å…è®¸
    'https://w.a.com',
    'https://w.x.cn',

    {url: 'https://servicewechat.com/wx234hiohr23', referer: true},
    // ä¸åº”ç”¨äº referer æ£€æµ‹ï¼Œå¦‚æœæœ‰è¯·æ±‚æäº¤äº† referer ä¸º self-define ä¸ä¼šé€šè¿‡æ£€æµ‹
    {url: 'self-define', referer: false}
  ],
})
```

---

### 2. Resource (é™æ€èµ„æºå¤„ç†)

é™æ€èµ„æºå¤„ç†æœåŠ¡ï¼Œä¸»è¦ç”¨äº JSã€CSSã€å›¾ç‰‡ã€éŸ³é¢‘ç­‰é™æ€æ–‡ä»¶çš„æ‰˜ç®¡ã€‚æ”¯æŒç¼“å­˜æ§åˆ¶ã€è·¯ç”±å‰ç¼€ä¿®æ­£ç­‰åŠŸèƒ½ã€‚

**åŸºæœ¬ä½¿ç”¨ï¼š**

```javascript
const Topbit = require('topbit')
const {Resource} = Topbit.extensions

let st = new Resource({
    // è®¾å®šé™æ€èµ„æºæ‰€åœ¨ç›®å½•
    staticPath: './public'
})

// åªå¯¹åˆ†ç»„ä¸º static æ‰§è¡Œä¸­é—´ä»¶ã€‚
app.use(st, {group: 'static'})

// æ·»åŠ é™æ€èµ„æºè·¯ç”±ï¼Œå‡è®¾ public ç›®å½•ä¸‹æœ‰ css/a.css
// è®¿é—® /static/css/a.css å³å¯
app.get('/static/*', async c => {
    // è¯·æ±‚åˆ†ç»„ä¸º static
}, '@static')
```

**å¿«é€Ÿç¤ºä¾‹ä¸é…ç½®è¯¦è§£ï¼š**

```javascript
let st = new Resource({
    // è®¾å®šé™æ€èµ„æºæ‰€åœ¨ç›®å½•
    staticPath: './public',

    // è·¯ç”±è·¯å¾„ï¼šå‰ç«¯å¿…é¡»ä»¥ /static/ å¼€å¤´ï¼Œæ˜ å°„åˆ° ./public ç›®å½•ä¸‹çš„æ–‡ä»¶
    routePath : '/static/*',

    // æŒ‡å®šè·¯ç”±åˆ†ç»„
    routeGroup: '_static',

    // æ˜¯å¦æ”¯æŒä¸­æ–‡è·¯å¾„è§£ç ï¼ˆé»˜è®¤ falseï¼‰
    decodePath: true,

    // å‰ç¼€è·¯å¾„ä¿®æ­£ã€‚å¦‚æœè®¾ç½®ä¸º xyzï¼Œä¼šè‡ªåŠ¨ä¿®æ­£ä¸º /xyzã€‚
    // prepath : '',

    // æœ€å¤§ç¼“å­˜æ–‡ä»¶å¤§å°ï¼Œè¶…è¿‡æ­¤å¤§å°åˆ™ä¸ä¼šç¼“å­˜ï¼ˆå•ä½å­—èŠ‚ï¼‰
    maxFileSize: 12_000_000,

    // è®¾ç½®æ¶ˆæ¯å¤´ cache-control çš„å€¼ï¼Œé»˜è®¤ä¸º null
    cacheControl: 'max-age=3600',
    
    // æœ€å¤§æ€»ç¼“å­˜å¤§å°ï¼ˆé»˜è®¤ 120MBï¼‰
    maxCacheSize: 120_000_000,

    // å¤±è´¥é™åˆ¶æ¬¡æ•°ä¸ç¼“å­˜é‡Šæ”¾æ¦‚ç‡
    failedLimit: 50,
    prob: 6
})

st.init(app)

// è‡ªåŠ¨æ·»åŠ åˆ° _static åˆ†ç»„ã€‚
// ä¾‹å¦‚ï¼špublic ç›®å½•ä¸­æœ‰ favicon.icoï¼Œé€šè¿‡æ­¤è¯·æ±‚å³å¯è·å–ã€‚
app.get('/favicon.ico', async c => {}, {group: '_static'})
```

**æ¥å£è¯´æ˜ï¼š**
*   `addType(obj)`: æ·»åŠ æ‰©å±•ååˆ° content-type çš„æ˜ å°„å…³ç³»ã€‚
*   `clearCache()`: æ¸…ç†ç¼“å­˜ã€‚

---

### 3. ToFile (æ–‡ä»¶ä¸Šä¼ å¯¹è±¡åŒ–)

è®©ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡å…·å¤‡ `toFile` æ–¹æ³•ï¼Œä¾¿äºæŒ‰ç…§é¢å‘å¯¹è±¡çš„é£æ ¼ä¿å­˜æ–‡ä»¶ã€‚

```javascript
const Topbit = require('topbit')
const {ToFile} = Topbit.extensions

app.use( new ToFile() )

app.post('/upload', async c => {
    // è·å–ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡
    let f = c.getFile('image')

    if (!f) {
        return c.status(400).oo('image file not found')
    }

    // æŠŠæ–‡ä»¶ç§»åŠ¨åˆ° images ç›®å½•ï¼ˆéœ€ç¡®ä¿ç›®å½•å­˜åœ¨ï¼‰ã€‚
    // ç¬¬äºŒä¸ªå‚æ•°å¯é€‰æŒ‡å®šæ–‡ä»¶åï¼Œé»˜è®¤æ ¹æ®æ—¶é—´æˆ³å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åã€‚
    let fname = await f.toFile('./images')

    // è¿”å›æ–‡ä»¶å
    c.ok(fname)
})

app.run(1234)

```

---

### 4. SSE (æœåŠ¡ç«¯æ¶ˆæ¯æ¨é€)

åŸºäº HTTP åè®®çš„ Server Sent Events (SSE) ä¸­é—´ä»¶ï¼Œç”¨äºå®ç°æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®æµã€‚

**åŸºæœ¬ä½¿ç”¨ï¼š**

```javascript
const Topbit = require('topbit')
const {SSE} = Topbit.extensions

let s = new SSE({
  // è¶…æ—¶20ç§’ï¼Œè¶…è¿‡æ­¤æ—¶é—´åä¼šè‡ªåŠ¨å…³é—­è¿æ¥
  timeout: 20000,

  // é‡æ–°å‘èµ·è¿æ¥æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º0è¡¨ç¤ºä¸å†å‘èµ·è¿æ¥
  retry: 5000,

  // å®šæ—¶å™¨é—´éš”ï¼Œæ¯éš”2ç§’æ‰§è¡Œä¸€æ¬¡å¤„ç†å‡½æ•°
  timeSlice: 2000
})

// è®¾ç½®å¤„ç†å‡½æ•°ï¼Œctx ä¸ºè¯·æ±‚ä¸Šä¸‹æ–‡
s.handle = (ctx) => {
    // å‘é€å•æ¡æ¶ˆæ¯
    ctx.sendmsg({event: 'eat', data: 'é¥­'})
    
    if (Date.now() % 5 === 0) {
        // å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œå­—ç¬¦ä¸²æˆ–æ•°å­—ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå¯¹åº”çš„æ¶ˆæ¯æ ¼å¼ï¼Œäº‹ä»¶é»˜è®¤ä¸º message
        ctx.sendmsg([
            {event: 'clock', data: Date.now()},
            'ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚',
            Math.random()
        ])
    }
}

// åªé’ˆå¯¹è·¯ç”±åˆ†ç»„ sse å¯ç”¨ä¸­é—´ä»¶
app.use( s, {group: 'sse'} )

app.get('/sse', async ctx => {}, {group: 'sse'})

app.run(1234)

```

**ç”Ÿæˆå™¨æ¨¡å¼ (Generator Mode)ï¼š**
é€‚ç”¨äºéœ€è¦åŠ¨æ€è°ƒæ•´æ—¶é—´é—´éš”æˆ–æ›´ç²¾ç¡®æ§åˆ¶çš„åœºæ™¯ã€‚

```javascript
let s = new SSE({
  timeout: 20000,
  retry: 5000,
  timeSlice: 10,
  mode: 'yield' // å¼€å¯ç”Ÿæˆå™¨æ¨¡å¼
})

s.handle = (ctx) => {
    ctx.sendmsg({event: 'eat', data: 'é¥­'})
    // ä½¿ç”¨ await ctx.sse.moment(ms) è¿›è¡Œå»¶è¿Ÿ
    await ctx.sse.moment(100)
}
```

---

### 5. Proxy (HTTP/1.1 åå‘ä»£ç†)

é’ˆå¯¹ HTTP/1.1 åè®®çš„åå‘ä»£ç†ï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡å’Œå­˜æ´»æ£€æµ‹ (Alive Check)ã€‚

**åŸºæœ¬ä»£ç†é…ç½®ï¼š**

```javascript
const Topbit = require('topbit')
const {Proxy} = Topbit.extensions

let hostcfg = {
    // ç®€å•æ˜ å°„ï¼šé»˜è®¤ path ä¸º /
    'a.com' : 'http://localhost:8001',

    // æŒ‡å®šè·¯å¾„æ˜ å°„
    'b.com' : {
        path : '/xyz',
        url : 'http://localhost:8002'
    },

    // å¤æ‚é…ç½®ä¸é‡å†™
    'c.com' : [
        {
            path : '/',
            url : 'http://localhost:8004',
            rewrite: (ctx, path) => {
              // è‡ªå®šä¹‰é‡å†™è·¯ç”±è§„åˆ™
              if (path.indexOf('/xyz') === 0) {
                return path.replace('/xyz', '/w')
              }
            }
        }
    ]
};

const pxy = new Proxy({
    timeout: 10000,
    config: hostcfg
})

pxy.init(app)

app.run(1234)

```

**è´Ÿè½½å‡è¡¡é…ç½®ï¼š**
é€šè¿‡é…ç½®æ•°ç»„å®ç°ï¼Œæ”¯æŒæƒé‡ (`weight`) å’Œå­˜æ´»æ£€æµ‹ã€‚

```javascript
let load_balance_cfg = {
    'a.com' : [
        {
            path : '/',
            url : 'http://localhost:1234',
            // æ¯3ç§’æ£€æµ‹æœåŠ¡å­˜æ´»
            aliveCheckInterval : 3,
            aliveCheckPath : '/alive-check',
            // æƒé‡ï¼Œæ•°å­—è¶Šå¤§æƒé‡è¶Šé«˜
            weight: 3
        },
        {
            path : '/',
            url : 'http://localhost:1235',
            aliveCheckInterval : 3,
            aliveCheckPath : '/ok',
            weight: 2
        }
    ]
}

const pxy = new Proxy({
    timeout: 10000,
    starPath : true, // å¼€å¯åå°†ä»£ç†è·¯å¾„åçš„å­—ç¬¦ä¸²ä½œä¸ºè·¯å¾„è½¬å‘
    config: load_balance_cfg
})

pxy.init(app)
```

---

### 6. Http2Proxy (HTTP/2 åå‘ä»£ç†)

HTTP/2 åè®®çš„åå‘ä»£ç†ï¼Œå‚æ•°ä¸ `Proxy` åŸºæœ¬ä¸€è‡´ï¼Œåˆ©ç”¨ HTTP/2 è¿æ¥æœºåˆ¶è¿›è¡Œä¿æ´»ã€‚

```javascript
const Topbit = require('topbit')
const {Http2Proxy} = Topbit.extensions

let hxy = new Http2Proxy({
  config: {
    'a.com' : [
      {
        url: 'http://localhost:3001',
        weight: 10,
        path : '/',
        reconnDelay: 200, // é‡è¿å»¶è¿Ÿ
        max: 2,
        headers: {
          'x-test-key': `${Date.now()}`
        },
        connectTimeout: 2000
      },
      {
        url: 'http://localhost:3002',
        weight: 4,
        path : '/'
      }
    ]
  },
  debug: true
})

hxy.init(app)

app.run(1234)
```

---

### 7. SNI (HTTPS å¤šåŸŸåæ”¯æŒ)

**æè¿°**ï¼šç”¨äºåœ¨åŒä¸€ IP åœ°å€å’Œç«¯å£ä¸Šæ”¯æŒå¤šä¸ª HTTPS åŸŸåè¯ä¹¦çš„ä¸­é—´ä»¶ã€‚

æ„Ÿè°¢æä¾›æºä»£ç ã€‚æ ¹æ®ä»£ç é€»è¾‘ï¼Œ`SNI` æ‰©å±•é€šè¿‡ `init` æ–¹æ³•å°† `SNICallback` æ³¨å…¥åˆ°åº”ç”¨çš„ `config.server` é…ç½®ä¸­ï¼Œä»è€Œåˆ©ç”¨ Node.js åŸç”Ÿ TLS çš„èƒ½åŠ›å®ç°å¤šåŸŸåè¯ä¹¦æ”¯æŒã€‚

ä»¥ä¸‹æ˜¯è¡¥å…¨åçš„ **SNI** æ–‡æ¡£éƒ¨åˆ†ï¼š

---

### 7. SNI (HTTPS å¤šåŸŸåæ”¯æŒ)

**æè¿°**ï¼šç”¨äºåœ¨åŒä¸€ IP åœ°å€å’Œç«¯å£ä¸Šæ”¯æŒå¤šä¸ª HTTPS åŸŸåè¯ä¹¦çš„ä¸­é—´ä»¶ã€‚å®ƒåˆ©ç”¨ TLS åè®®çš„ Server Name Indication ç‰¹æ€§ï¼Œæ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚çš„åŸŸååŠ¨æ€åŠ è½½å¯¹åº”çš„ SSL è¯ä¹¦ã€‚

**æ³¨æ„**ï¼šåˆå§‹åŒ–æ—¶ä¼šåŒæ­¥è¯»å–è¯ä¹¦æ–‡ä»¶ï¼Œè¯·ç¡®ä¿è·¯å¾„æ­£ç¡®ã€‚å¦‚æœæŸä¸ªåŸŸåçš„è¯ä¹¦è¯»å–å¤±è´¥ï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œä½†ä¸ä¼šé˜»å¡å…¶ä»–åŸŸåçš„åŠ è½½ã€‚

**ä½¿ç”¨ï¼š**

```javascript
const Topbit = require('topbit')
const {SNI} = Topbit.extensions

const app = new Topbit({
    // å¯ç”¨ HTTPSï¼Œé€šå¸¸å»ºè®®é…ç½®ä¸€ç»„é»˜è®¤çš„ key å’Œ cert ä½œä¸ºå›é€€
    https: true,
    key: './ssl/default.key',
    cert: './ssl/default.cert',
    debug: true
})

// é…ç½®å¤šåŸŸåè¯ä¹¦
// Key ä¸ºåŸŸåï¼ŒValue ä¸ºåŒ…å« key å’Œ cert è·¯å¾„çš„å¯¹è±¡
let certs = {
    'a.com': {
        key: './ssl/a.com.key',
        cert: './ssl/a.com.cert'
    },
    'www.b.org': {
        key: '/etc/nginx/ssl/b.org.key',
        cert: '/etc/nginx/ssl/b.org.crt'
    }
}

// å®ä¾‹åŒ–å¹¶åˆå§‹åŒ–
let sni = new SNI(certs)

// init æ–¹æ³•ä¼šå°† SNICallback æ³¨å…¥åˆ° app.config.server ä¸­
sni.init(app)

app.run(443)
```

**å‚æ•°è¯´æ˜**ï¼š
*   æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå¯¹è±¡ï¼Œé”®åä¸º**åŸŸå**ï¼Œé”®å€¼ä¸ºé…ç½®å¯¹è±¡ã€‚
*   é…ç½®å¯¹è±¡å¿…é¡»åŒ…å«ï¼š
    *   `key`: ç§é’¥æ–‡ä»¶çš„è·¯å¾„ã€‚
    *   `cert`: è¯ä¹¦æ–‡ä»¶çš„è·¯å¾„ã€‚

---

### 8. ParamCheck (è¯·æ±‚å‚æ•°æ£€æµ‹)

æ”¯æŒå¯¹ `param` (è·¯ç”±å‚æ•°)ã€`query` (æŸ¥è¯¢å­—ç¬¦ä¸²)ã€`body` (è¯·æ±‚ä½“) è¿›è¡Œå£°æ˜å¼æ£€æµ‹ã€‚

**Query å’Œ Param æ£€æµ‹ï¼š**

```javascript
const Topbit = require('topbit')
const {ParamCheck} = Topbit.extensions

// Query å‚æ•°æ£€æµ‹
let pck = new ParamCheck({
  key: 'query',
  data : {
    // ä¸¥æ ¼é™åˆ¶å€¼
    say: 'hello',
    // ç±»å‹è½¬æ¢ä¸èŒƒå›´é™åˆ¶
    offset: {
      default: 0,
      to: 'int',
      min: 0,
      max: 100
    }
  }
})

// Param å‚æ•°æ£€æµ‹ä¸è‡ªå®šä¹‰å›è°ƒ
let paramck = new ParamCheck({
  key: 'param',
  deny: ['x-key'], // ç¦æ­¢æäº¤çš„å­—æ®µ
  deleteDeny: true,
  data : {
    errorMessage: 'å‚æ•°é”™è¯¯', // è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯
    mobile: {
      callback: (obj, k, method) => {
        let preg = /^(12|13|15|16|17|18|19)[0-9]{9}$/
        return preg.test(obj[k])
      }
    }
  }
})

app.use(pck, {method: 'GET'})
   .use(paramck, {method: 'GET'})
```

**Body æ£€æµ‹ï¼š**

```javascript
let pmbody = new ParamCheck({
  key: 'body',
  data: {
    username: { must: true },
    passwd: { must: true }
  }
})

app.use(pmbody, {method: ['POST', 'PUT'], name: 'login'})
```

---

### 9. JWT (Token éªŒè¯)

JWT åè®®çš„ Token éªŒè¯ä¸ç­¾å‘ã€‚æ¨èä½¿ç”¨ `Topbit.Token` æ›¿ä»£ã€‚

```javascript
const Topbit = require('topbit')
const {JWT} = Topbit.extensions

let j = new JWT({
  timeout: 7200000, // è¶…æ—¶æ—¶é—´
})
j.alg = 'hs512' // è®¾ç½®ç®—æ³•

// ç­¾å‘ Token
let token = j.make({
  id: '123we',
  username: 'long'
})

// éªŒè¯ Token
// è¿”å›å¯¹è±¡ï¼š{ ok: true, data: {...} } æˆ– { ok: false, errcode: '...' }
let r = j.verify(token)

// ä½œä¸ºä¸­é—´ä»¶ä½¿ç”¨
// éªŒè¯æˆåŠŸä¼šå°†æ•°æ®æŒ‚è½½åˆ° ctx.box.user
app.pre(j.mid()) 
```

---

### 10. Cookie (Cookie è§£æ)

è§£æå‰ç«¯è¯·æ±‚æ¶ˆæ¯å¤´ä¸­çš„ Cookieï¼Œå¹¶åœ¨è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­æ·»åŠ  `cookie` å±æ€§ã€‚

```javascript
const Topbit = require('topbit')
const {Cookie} = Topbit.extensions

app.use( new Cookie() )

app.get('/', async ctx => {
  // è·å–è§£æåçš„ cookie å¯¹è±¡
  console.log(ctx.cookie)
})

app.run(1234)

```

---

### 11. Session (ä¼šè¯ç®¡ç†)

åŸºäºæœ¬åœ°æ–‡ä»¶æœºåˆ¶çš„ Session ä¼šè¯ç®¡ç†ï¼Œä¾èµ– Cookie ç»„ä»¶ã€‚
**æ³¨æ„**ï¼šæ­¤æ‰©å±•ä¸»è¦ç”¨äºæµ‹è¯•å’Œæ•™å­¦ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis æˆ–å…¶ä»–æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆã€‚

```javascript
const Topbit = require('topbit')
const {Cookie,Session} = Topbit.extensions

let sess = new Session()
sess.init(app) // åˆå§‹åŒ–ï¼šæ·»åŠ  ctx åŸå‹æ–¹æ³•

// å¿…é¡»å…ˆå¯ç”¨ Cookieï¼Œå†å¯ç”¨ Session
app.use( new Cookie() ).use( sess )

app.get('/:key/:data', async ctx => {
  // è®¾ç½® Session
  ctx.setSession(ctx.param.key, ctx.param.data)
  
  // è·å– Session (key é»˜è®¤ä¸º null è·å–æ‰€æœ‰)
  let data = ctx.getSession()
  
  ctx.ok(data)
})

app.run(1234)

// å…¶ä»–æ–¹æ³•ï¼š
// ctx.delSession(key) - åˆ é™¤æŒ‡å®š Session
// ctx.clearSession()  - æ¸…ç©º Session
```

---

## âŒ¨ï¸å‘½ä»¤å‚æ•°è§£æ

**ç”¨äºå¿«é€Ÿè§£æprocess.argvã€‚**


### ä½¿ç”¨ç¤ºä¾‹

```javascript

'use strict'

const Topbit = require('Topbit')
const parseArgv = Topbit.npargv

let ret = parseArgv({
  '--port=' : {
    name: 'port',
    //åˆ«å
    alias: '-p',
    type: 'int',
    min: 2000,
    max: 2100
  },

  '--host=' : {
    name: 'host',
    match: /^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/i
  },

  '-w' : {
    name: 'worker',
    type: 'int',
    min: 1,
    max: 4,
    //è‹¥è®¾ç½®äº†é»˜è®¤å€¼ï¼Œåˆ™åœ¨å‚æ•°ä¸åˆæ³•æ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤å€¼ä¸ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ã€‚
    default: 2
  },

  '--https': {
    name: 'https'
  },

  '--http2': {
    name: 'http2'
  },

  '--test': {
    name: 'test'
  },

  '--id' : {
    name : 'id',
    callback: (str) => {
      return str.split(',').filter(p => p.length > 0)
    }
  },

  //è‡ªåŠ¨è½¬æ¢ä¸º{type: 'bool', name: 'limit'}
  '--limit' : 'limit',

  //è‡ªåŠ¨è½¬æ¢ä¸º{type: 'bool', name: '-x'}
  '-x' : false

})

console.log(ret)

```

è¿è¡Œå‘½ä»¤å‚æ•°ï¼š

```shell
$ node test.js x --host=1.2.3.4 --https --http2 --test --port=2010 --id 1,2,3,4,5 --local a b c
```

è¿è¡Œè¾“å‡ºç»“æœï¼š

```javascript
{
  ok: true,
  errmsg: '',
  args: {
    worker: 2,
    https: true,
    http2: true,
    test: true,
    limit: false,
    host: '1.2.3.4',
    port: 2010,
    id: [ '1', '2', '3', '4', '5' ],
    '--local': true,
    '-x': false
  },
  // ä¸æ˜¯å‚æ•°ï¼Œä¹Ÿä¸æ˜¯-å¼€å¤´çš„ä¼šæ”¾åœ¨listä¸­ï¼Œæ–¹ä¾¿è·å–ã€‚
  // å¦‚æœå­˜åœ¨ä½ç½®å¼•ç”¨çš„å‚æ•°ï¼Œåˆ™ä¼šä¼˜å…ˆè§£æï¼Œæ‰€ä»¥xæ²¡æœ‰åœ¨listä¸­ã€‚
  list: ['a', 'b', 'c']
}

```

è§£æåçš„ç»“æœï¼Œè‹¥okä¸ºfalseï¼Œåˆ™errmsgä¼šç»™å‡ºé”™è¯¯æç¤ºä¿¡æ¯ã€‚è‹¥å‚æ•°æ— é”™è¯¯ï¼Œåˆ™argsæ˜¯è§£æåçš„å‚æ•°å¯¹è±¡ã€‚

è§£æè¿‡ç¨‹ä¸­ï¼Œè‹¥å‚æ•°ä¸åœ¨ä¼ é€’çš„å¯¹è±¡æè¿°ä¿¡æ¯å†…ï¼Œä»ç„¶ä¼šåœ¨argsä¸­ä½“ç°ï¼Œkeyå€¼å³ä¸ºå‚æ•°çš„åå­—ï¼Œå¯ä»¥å‚è€ƒç¤ºä¾‹ä¸­çš„--localã€‚

å¦‚æœå¯¹å‚æ•°çš„æè¿°ä¿¡æ¯ä¸æ˜¯objectç±»å‹ï¼Œåˆ™ä¼šè½¬æ¢ä¸ºbooleanç±»å‹ï¼Œæ­¤æ—¶nameå€¼å³ä¸ºå‚æ•°çš„åå­—ã€‚å‚è€ƒ-xå‚æ•°ã€‚

**è‹¥æ²¡æœ‰ç»™å®štypeé™å®šèŒƒå›´ï¼Œåˆ™ä¼šæ ¹æ®æè¿°è‡ªåŠ¨è®¾å®štypeï¼Œè¿™å¯èƒ½ä¼šæœ‰é”™è¯¯åˆ¤æ–­ï¼Œæ‰€ä»¥å°½å¯èƒ½ç»™å®štypeé™å®šã€‚**

**typeæ¨æ–­è§„åˆ™å¦‚ä¸‹ï¼š**

- è‹¥å‚æ•°å«æœ‰=ï¼Œæ¯”å¦‚--port=ï¼Œåˆ™typeä¸ºstringç±»å‹ã€‚

- å¦åˆ™ï¼Œè‹¥æè¿°å¯¹è±¡å…·å¤‡matchæˆ–callbackï¼Œåˆ™ä¸ºstringç±»å‹ã€‚

- å¦åˆ™ï¼Œè‹¥æè¿°å¯¹è±¡å«æœ‰minæˆ–maxåˆ™ä¸ºintç±»å‹ã€‚

- å¦åˆ™ï¼Œè‹¥æè¿°å¯¹è±¡å…·å¤‡defaultï¼Œåˆ™å¦‚æœdefaultæ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²ç±»å‹ï¼Œtypeå’Œdefaultç±»å‹ä¸€è‡´ã€‚

- å¦åˆ™ï¼Œtypeä¸ºboolã€‚

**typeæ”¯æŒç±»å‹å¦‚ä¸‹ï¼š**

- int æˆ– numberï¼Œæ•´æ•°ç±»å‹ã€‚

- floatï¼Œæµ®ç‚¹æ•°ç±»å‹ã€‚

- stringï¼Œå­—ç¬¦ä¸²ç±»å‹ã€‚

- boolæˆ–booleanï¼Œå¸ƒå°”ç±»å‹ã€‚

### å‚æ•°æè¿°çš„é€‰é¡¹

| é€‰é¡¹ | æ˜¯å¦å¿…é¡» | æè¿° |
| ---- | ---- | ---- |
| type | å¦ | å‚æ•°ç±»å‹ï¼Œè‹¥ä¸ç»™å®šåˆ™ä¼šæ ¹æ®æè¿°ä¿¡æ¯è‡ªåŠ¨è®¾å®šã€‚ |
| name | å¦ | è§£æåå‚æ•°çš„åå­—ï¼Œå°±æ˜¯è§£æåå‚æ•°å¯¹è±¡çš„keyå€¼ã€‚è‹¥ä¸ç»™å®šåˆ™ä½¿ç”¨å‚æ•°åç§°ã€‚ |
| min | å¦ | é™åˆ¶æœ€å°å€¼ã€‚ |
| max | å¦ | é™åˆ¶æœ€å¤§å€¼ã€‚ |
| default | å¦ | é»˜è®¤å€¼ï¼Œè‹¥è®¾ç½®ï¼Œåˆ™æ£€æµ‹åˆ°ä¼ é€’çš„å‚æ•°ä¸åˆæ³•ï¼Œä¼šé‡‡ç”¨é»˜è®¤å€¼ä¸ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ã€‚å¯¹äºboolæ¥è¯´ï¼Œdefaultæ— æ•ˆã€‚é»˜è®¤å€¼ä¸ºfalseã€‚ |
| match | å¦ | æ­£åˆ™è¡¨è¾¾å¼ï¼Œè‹¥ç»™å®šï¼Œä¼šè¿›è¡Œæ­£åˆ™åŒ¹é…ã€‚ |
| callback | å¦ | å‡½æ•°ï¼Œè‹¥ç»™å®šï¼Œä¼šæŠŠå‚æ•°å€¼ä¼ é€’åˆ°å‡½æ•°ï¼Œè‹¥å‡½æ•°è¿”å›å€¼ä¸æ˜¯undefinedï¼Œåˆ™ä½œä¸ºæœ€åè§£æçš„å€¼ã€‚ |

### autoDefaultè‡ªåŠ¨è®¾å®šé»˜è®¤å€¼

åœ¨ç¨‹åºè§£æè¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦å¿…é¡»è¿”å›å‚æ•°ï¼Œä¸åˆæ³•åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼Œè¿™éœ€è¦å¯¹æ¯ä¸ªé€‰é¡¹éƒ½ä½¿ç”¨defaultå±æ€§ï¼Œæˆ–è€…ä½¿ç”¨\@autoDefaultè®©npargvè‡ªåŠ¨è®¾å®šé»˜è®¤å€¼ã€‚

```javascript
'use strict'

const Topbit = require('Topbit')
const parseArgv = Topbit.npargv

let opts = {
  //å¯ç”¨è‡ªåŠ¨è®¾å®šé»˜è®¤å€¼ã€‚
  '@autoDefault' : true,

  //æ²¡æœ‰è®¾å®šé»˜è®¤å€¼ï¼Œä¼šè‡ªåŠ¨è®¾å®šé»˜è®¤å€¼ä¸ºminçš„å€¼ã€‚
  '--port' : {
    min: 1234,
    max: 5678
  },

  //æ²¡æœ‰defaultè®¾å®šé»˜è®¤å€¼ï¼Œç±»å‹ä¸ºæ•°å­—ä¹Ÿæ²¡æœ‰minçš„é™åˆ¶ï¼Œä¼šè‡ªåŠ¨è®¾ç½®ä¸º0
  '-x' : {
    type : 'int'
  }


}

let {args} = parseArgv(opts)

```

è‡ªåŠ¨è®¾å®šé»˜è®¤å€¼çš„è§„åˆ™ï¼š

- è‹¥typeä¸ºboolåˆ™é»˜è®¤å€¼ä¸ºfalse

- è‹¥typeä¸ºstringï¼Œåˆ™é»˜è®¤å€¼ä¸º ç©ºå­—ç¬¦ä¸²ã€‚

- è‹¥typeä¸ºnumberã€intã€floatï¼Œåˆ™é»˜è®¤å€¼ä¸ºminå±æ€§ç»™å®šçš„å€¼ï¼Œè‹¥æ²¡æœ‰minåˆ™é»˜è®¤å€¼ä¸º0ã€‚

### ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºå­å‘½ä»¤

```javascript

let argscfg = {
    //å®šä¹‰æ”¯æŒçš„å­å‘½ä»¤
    '@command' : [
        'create', 'show', 'update', 'delete'
    ],

    //å½“ä¸è¾“å…¥æ—¶ï¼Œé»˜è®¤çš„å‘½ä»¤
    '@defaultCommand': 'show'
}


```

### ä½ç½®å¼•ç”¨å‚æ•°

ä»¥ $ åŠ æ•°å­—ä½œä¸ºkeyå€¼å³è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªä½ç½®ç›¸å…³çš„å‚æ•°ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­ä¼šå…ˆè¿›è¡Œä½ç½®å¼•ç”¨å‚æ•°çš„è§£æã€‚

ä½†æ˜¯ä½ç½®çš„ç´¢å¼•æ•°å­—å’Œå®é™…å†…éƒ¨çš„ç´¢å¼•æœ‰å·®å¼‚ï¼š

- ç´¢å¼•ä½ç½®ä»1å¼€å§‹ã€‚

- ç´¢å¼•ä½ç½®æ˜¯å‚æ•°å€¼ï¼Œä¸ä¼šåŒ…æ‹¬å‘½ä»¤åç§°ã€‚

- å¦‚æœè®¾å®šäº†@commandï¼Œåˆ™ä½ç½®1ä¼šè‡ªåŠ¨åœ¨è§£ææ—¶ä»commandåå¼€å§‹ã€‚

æ³¨æ„ï¼š@commandè¡¨ç¤ºçš„æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºè„šæœ¬çš„å­å‘½ä»¤åŠŸèƒ½ã€‚

```javascript
const Topbit = require('Topbit')
const npargv = Topbit.npargv

let {args} = npargv({
    '@autoDefault': true,
    '$1': {
        type: 'string',
    },
    '$2': {
        type: 'string',
        callback: (v) => {
            return ['i', 'o', 'v'].indexOf(v) >= 0 ? v : 'o'
        }
    }
})

```

---

## ğŸ¤–Loader(æœåŠ¡åŠ è½½å™¨)

TopbitLoader æ˜¯ Topbit æ¡†æ¶å®˜æ–¹æ¨èçš„ã€Œè‡ªåŠ¨åŒ–åŠ è½½å™¨ã€æ‰©å±•ï¼Œå½»åº•å‘Šåˆ«æ‰‹åŠ¨ `app.get()`ã€`app.use()` çš„ç¹çå†™æ³•ã€‚

å®ƒå®ç°äº†çœŸæ­£çš„ **MCM æ¨¡å¼**ï¼ˆMiddleware â†’ Controller â†’ Modelï¼‰ï¼Œç±»ä¼¼ MVC ä½†æ›´è½»é‡ã€æ›´ç¬¦åˆ Topbit çš„æè‡´æ€§èƒ½å“²å­¦ã€‚

[ğŸŒæŸ¥çœ‹è¯¦ç»†æ–‡æ¡£â˜›](./docs/topbit-loader.md)

---

## ğŸ”Token(ä¼šè¯éªŒè¯)ğŸª™

TopbitToken æ˜¯ä¸“ä¸º Topbit æ¡†æ¶æ‰“é€ çš„é›¶ä¾èµ–ã€æç®€ã€é«˜å®‰å…¨çš„åŠ å¯†ç”¨æˆ·å‡­è¯ï¼ˆTokenï¼‰ç³»ç»Ÿã€‚

å®ƒå®Œå…¨åŸºäº Node.js åŸç”Ÿ `crypto` å®ç°ï¼Œæ”¯æŒï¼š

- AES-256-GCMï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
- AES-192-GCM / AES-128-CBC / AES-256-CBC
- å›½å¯† SM4-CBC

[ğŸŒæŸ¥çœ‹è¯¦ç»†æ–‡æ¡£â˜›](./docs/topbit-token.md)

---
